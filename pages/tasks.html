<section class="page tasks" id="tasks-page" aria-labelledby="tasks-title">
  <h1 id="tasks-title">–ó–∞–¥–∞—á–∏</h1>

  <!-- –ü–∞–Ω–µ–ª—å -->
  <div class="cases-toolbar" role="region" aria-label="–ü–æ–∏—Å–∫ –∏ –¥–µ–π—Å—Ç–≤–∏—è">
    <div class="cases-search">
      <input id="tasks-search-input" type="search" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, –Ω–æ–º–µ—Ä –¥–µ–ª–∞, –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ"
             aria-label="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–¥–∞—á–∞–º" oninput="TASKS && TASKS.setQuery(this.value)" />
      <button class="ghost" aria-label="–û—á–∏—Å—Ç–∏—Ç—å"
              onclick="TASKS && TASKS.setQuery(''); const i=document.getElementById('tasks-search-input'); i.value=''; i.focus();">‚úï</button>
    </div>
    <button class="primary" id="tasks-add-btn" aria-expanded="false" onclick="TASKS && TASKS.toggleForm()">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>

  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <div class="cases-filters" role="tablist" aria-label="–§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É">
    <button role="tab" class="chip active" data-filter="all" onclick="TASKS && TASKS.setFilter('all')">–í—Å–µ</button>
    <button role="tab" class="chip" data-filter="upcoming" onclick="TASKS && TASKS.setFilter('upcoming')">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ</button>
    <button role="tab" class="chip" data-filter="overdue" onclick="TASKS && TASKS.setFilter('overdue')">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</button>
    <button role="tab" class="chip" data-filter="archived" onclick="TASKS && TASKS.setFilter('archived')">–ê—Ä—Ö–∏–≤</button>
  </div>

  <!-- –§–æ—Ä–º–∞ -->
  <div id="tasks-form-wrap" class="collapse" aria-hidden="true" style="margin-top:10px;">
    <form id="tasks-form" class="cases-form" onsubmit="TASKS && TASKS.submit(event)">
      <div class="grid">
        <label>
          <span>–ù–∞–∑–≤–∞–Ω–∏–µ *</span>
          <input type="text" id="t-title" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ—Ç–∑—ã–≤" />
        </label>
        <label class="has-suggest">
          <span>–ù–æ–º–µ—Ä –¥–µ–ª–∞</span>
          <input type="text" id="t-case" placeholder="–ê40-12345/2025" autocomplete="off" />
          <div id="t-case-suggest" class="suggest" role="listbox" hidden></div>
        </label>
        <label class="has-suggest">
          <span>–î–æ–ª–∂–Ω–∏–∫</span>
          <input type="text" id="t-debtor" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò. / –û–û–û ¬´–†–æ–≥–∞ –∏ –ö–æ–ø—ã—Ç–∞¬ª" autocomplete="off" />
          <div id="t-debtor-suggest" class="suggest" role="listbox" hidden></div>
        </label>
        <label>
          <span>–°—Ä–æ–∫</span>
          <input type="datetime-local" id="t-due" />
        </label>
        <label style="grid-column: 1 / -1;">
          <span>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</span>
          <textarea id="t-note" rows="2" placeholder="–õ—é–±—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –∑–∞–¥–∞—á–µ"></textarea>
        </label>
        <label>
          <span>–°—Ç–∞—Ç—É—Å</span>
          <select id="t-status">
            <option value="active" selected>–ê–∫—Ç–∏–≤–Ω–∞—è</option>
            <option value="done">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
            <option value="archived">–ê—Ä—Ö–∏–≤</option>
          </select>
        </label>
      </div>
      <div class="form-actions">
        <button type="button" class="ghost" onclick="TASKS && TASKS.toggleForm(false)">–°–≤–µ—Ä–Ω—É—Ç—å</button>
        <button type="submit" class="primary" id="tasks-submit-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>

  <!-- –°–ø–∏—Å–æ–∫ -->
  <div id="tasks-list" class="cases-list" role="list"></div>
  <div class="list-spacer" aria-hidden="true"></div>

  <!-- –ü—É—Å—Ç–æ–µ -->
  <div id="tasks-empty" class="cases-empty" hidden>
    <div class="emoji" aria-hidden="true">üìù</div>
    <div class="title">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á</div>
    <div class="hint">–î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É: –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –æ—Å—Ç–∞–ª—å–Ω–æ–µ –ø–æ –∂–µ–ª–∞–Ω–∏—é.</div>
    <button class="primary" onclick="TASKS && TASKS.toggleForm(true)">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
  </div>

  <style>
    .cases-toolbar{ display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; }
    .cases-search{ display:grid; grid-template-columns:1fr auto; gap:6px; }
    .cases-search input{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--separator);
      background:var(--tg-theme-secondary-bg-color); color:var(--tg-theme-text-color); outline:none; }
    .cases-search input:focus{ border-color:var(--app-accent); }
    .cases-filters{ display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .chip{ border:1px solid var(--separator); background:transparent; color:var(--tg-theme-text-color);
      padding:6px 10px; border-radius:999px; cursor:pointer; }
    .chip.active{ border-color:var(--app-accent); color:var(--app-accent); font-weight:600; }

    .collapse{ max-height:0; overflow:hidden; opacity:0; transition:max-height 240ms ease, opacity 240ms ease; }
    .collapse.open{ opacity:1; }

    .cases-form{ border:1px solid var(--separator); background:var(--tg-theme-secondary-bg-color);
      border-radius:16px; padding:12px; display:grid; gap:12px; margin-top:8px; }
    .cases-form .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .cases-form label{ display:grid; gap:6px; font-size:12px; color:var(--tg-theme-hint-color); }
    .cases-form input,.cases-form select,.cases-form textarea{
      padding:10px 12px; border-radius:12px; border:1px solid var(--separator);
      background:var(--tg-theme-bg-color); color:var(--tg-theme-text-color); outline:none; resize:vertical;
    }
    .cases-form input:focus,.cases-form select:focus,.cases-form textarea:focus{ border-color:var(--app-accent); }
    .form-actions{ display:flex; gap:8px; justify-content:flex-end; }
    .primary,.ghost{ appearance:none; border:1px solid transparent; padding:10px 12px; border-radius:12px; cursor:pointer;
      background:var(--tg-theme-button-color); color:var(--tg-theme-button-text-color); }
    .ghost{ background:transparent; border-color:var(--separator); color:var(--tg-theme-text-color); }

    .has-suggest{ position:relative; }
    .suggest{ position:absolute; top:100%; left:0; right:0; z-index:10; background:var(--tg-theme-bg-color);
      border:1px solid var(--separator); border-radius:12px; margin-top:6px; max-height:220px; overflow:auto;
      box-shadow:0 6px 24px rgba(0,0,0,.25); }
    .suggest-item{ padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; gap:12px; }
    .suggest-item:hover, .suggest-item[aria-selected="true"]{ background:var(--tg-theme-secondary-bg-color); }
    .suggest-item .hint{ color:var(--tg-theme-hint-color); font-size:12px; }

    .cases-list{ display:grid; gap:8px; margin-top:8px; }
    .case-card{ border:1px solid var(--separator); background:var(--tg-theme-secondary-bg-color);
      border-radius:16px; padding:12px; display:grid; gap:6px; }
    .case-head{ display:flex; justify-content:space-between; align-items:baseline; gap:8px; }
    .case-number{ font-weight:700; }
    .badge{ font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--separator); color:var(--tg-theme-hint-color); }
    .badge.active{ color:var(--app-accent); border-color:var(--app-accent); }
    .case-row{ display:flex; gap:10px; flex-wrap:wrap; color:var(--tg-theme-hint-color); font-size:14px; }
    .case-actions{ display:flex; gap:8px; margin-top:6px; }

    .cases-empty{ text-align:center; padding:20px 8px; color:var(--tg-theme-hint-color); }
    .cases-empty .emoji{ font-size:36px; margin-bottom:8px; }
    .cases-empty .title{ font-weight:700; color:var(--tg-theme-text-color); }
    .list-spacer{ height:16px; }

    @media (max-width:520px){ .cases-form .grid{ grid-template-columns:1fr; } .suggest{ max-height:50vh; } }
  </style>

  <script type="text/plain" id="tasks-inline-js">
  (function(){
    const DAY=24*60*60*1000;

    function setExpanded(btn, wrap, open){ btn?.setAttribute('aria-expanded', String(open)); wrap?.setAttribute('aria-hidden', String(!open)); }
    const nowTs=()=>Date.now();
    function toTs(dt){ if(!dt) return NaN; const ts=Date.parse(dt); return isNaN(ts)?NaN:ts; }
    function fmtDateTime(dt){ try{ const d=new Date(dt); return d.toLocaleString('ru-RU'); }catch(_){ return '‚Äî'; } }

    function loadCasesIndex(){
      try{
        const raw=localStorage.getItem('tl_cases_v1'); if(!raw) return [];
        const arr=JSON.parse(raw)||[]; const map=new Map();
        arr.forEach(c=>{ if(!c||!c.number) return; const key=String(c.number).trim();
          if(!map.has(key)) map.set(key,{number:key, debtor:c.debtor||''}); });
        return Array.from(map.values());
      }catch(_){ return []; }
    }

    window.TASKS = {
      LS_KEY:'tl_tasks_v1',
      data:[],
      casesIndex:[],
      state:{ query:'', filter:'all' },
      editingId:null,

      refreshCasesIndex(){ this.casesIndex=loadCasesIndex(); },

      init(){
        try{ const raw=localStorage.getItem(this.LS_KEY); this.data=raw?JSON.parse(raw):[]; if(!Array.isArray(this.data)) this.data=[]; }catch(e){ this.data=[]; }
        this.refreshCasesIndex();
        this.autoArchiveCompleted();
        this.initCaseSuggest();
        this.render();
      },

      save(){ localStorage.setItem(this.LS_KEY, JSON.stringify(this.data)); },
      setQuery(v){ this.state.query=(v||'').toLowerCase(); this.render(); },
      setFilter(f){
        this.state.filter=f;
        document.querySelectorAll('#tasks-page .chip').forEach(ch=>{
          ch.classList.toggle('active', ch.dataset.filter===f);
          ch.setAttribute('aria-selected', String(ch.dataset.filter===f));
        });
        this.render();
      },

      toggleForm(force){
        const wrap=document.getElementById('tasks-form-wrap'); const btn=document.getElementById('tasks-add-btn');
        const isOpen=wrap.classList.contains('open'); const shouldOpen=(typeof force==='boolean')?force:!isOpen; if(shouldOpen===isOpen) return;
        wrap.style.overflow='hidden';
        if(shouldOpen){ wrap.classList.add('open'); wrap.style.maxHeight=wrap.scrollHeight+'px'; setExpanded(btn,wrap,true); document.getElementById('t-title').focus(); }
        else{ wrap.style.maxHeight=wrap.scrollHeight+'px'; requestAnimationFrame(()=>{ wrap.style.maxHeight='0px'; }); setExpanded(btn,wrap,false); wrap.addEventListener('transitionend',()=>{ wrap.classList.remove('open'); TASKS.cancelEdit(); },{once:true}); }
      },

      // –ü–æ–¥—Å–∫–∞–∑–∫–∏
      initCaseSuggest(){
        const cI=document.getElementById('t-case'), cBox=document.getElementById('t-case-suggest');
        if(cI && cBox){
          const update=()=>{ this.refreshCasesIndex(); this.buildCaseSuggestions(cBox, cI.value); };
          cI.addEventListener('input', update); cI.addEventListener('focus', update);
          cI.addEventListener('blur', ()=>setTimeout(()=>{ cBox.hidden=true; },120));
          cBox.addEventListener('mousedown',(e)=>{
            const item=e.target.closest('.suggest-item'); if(!item) return;
            cI.value=item.getAttribute('data-number')||'';
            const d=document.getElementById('t-debtor'); if(d && !d.value) d.value=item.getAttribute('data-debtor')||'';
            cBox.hidden=true;
          });
        }
        const dI=document.getElementById('t-debtor'), dBox=document.getElementById('t-debtor-suggest');
        if(dI && dBox){
          const updateD=()=>{ this.refreshCasesIndex(); this.buildDebtorSuggestions(dBox, dI.value); };
          dI.addEventListener('input', updateD); dI.addEventListener('focus', updateD);
          dI.addEventListener('blur', ()=>setTimeout(()=>{ dBox.hidden=true; },120));
          dBox.addEventListener('mousedown',(e)=>{
            const item=e.target.closest('.suggest-item'); if(!item) return;
            dI.value=item.getAttribute('data-debtor')||'';
            const c=document.getElementById('t-case'); if(c && !c.value) c.value=item.getAttribute('data-number')||'';
            dBox.hidden=true;
          });
        }
      },
      buildCaseSuggestions($box, query){
        const list=this.casesIndex||[]; const q=(query||'').toLowerCase().trim();
        let items=!q?list.slice(0,7):list.filter(c=>c.number.toLowerCase().includes(q)).slice(0,7);
        if(!items.length){ $box.hidden=true; $box.innerHTML=''; return; }
        $box.innerHTML=items.map(c=>`
          <div class="suggest-item" role="option" data-number="${c.number}" data-debtor="${c.debtor||''}">
            <span>${c.number}</span><span class="hint">${c.debtor||''}</span>
          </div>`).join('');
        $box.hidden=false;
      },
      buildDebtorSuggestions($box, query){
        const list=this.casesIndex||[]; const q=(query||'').toLowerCase().trim();
        let items=!q?list.slice(0,7):list.filter(c=>(c.debtor||'').toLowerCase().includes(q)).slice(0,7);
        if(!items.length){ $box.hidden=true; $box.innerHTML=''; return; }
        $box.innerHTML=items.map(c=>`
          <div class="suggest-item" role="option" data-number="${c.number}" data-debtor="${c.debtor||''}">
            <span>${c.debtor||''}</span><span class="hint">${c.number}</span>
          </div>`).join('');
        $box.hidden=false;
      },

      // CRUD
      edit(id){
        const i=this.data.find(x=>x.id===id); if(!i) return; this.editingId=id;
        document.getElementById('t-title').value=i.title||''; document.getElementById('t-case').value=i.caseNumber||'';
        document.getElementById('t-debtor').value=i.debtor||''; document.getElementById('t-due').value=i.due||'';
        document.getElementById('t-note').value=i.note||''; document.getElementById('t-status').value=i.status||'active';
        document.getElementById('tasks-submit-btn').textContent='–û–±–Ω–æ–≤–∏—Ç—å';
        const wrap=document.getElementById('tasks-form-wrap'); if(!wrap.classList.contains('open')) this.toggleForm(true);
      },
      cancelEdit(){ this.editingId=null; document.getElementById('tasks-submit-btn').textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        ['t-title','t-case','t-debtor','t-due','t-note'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
        document.getElementById('t-status').value='active';
      },
      submit(ev){
        ev.preventDefault();
        const title=document.getElementById('t-title').value.trim();
        const caseNumber=document.getElementById('t-case').value.trim();
        const debtor=document.getElementById('t-debtor').value.trim();
        const due=document.getElementById('t-due').value;
        const note=document.getElementById('t-note').value.trim();
        const status=document.getElementById('t-status').value;
        if(!title){ alert('–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏.'); return; }

        if(this.editingId){
          const i=this.data.findIndex(x=>x.id===this.editingId);
          if(i!==-1) this.data[i]={...this.data[i], title, caseNumber, debtor, due, note, status, updatedAt:Date.now()};
        } else {
          this.data.push({ id:String(Date.now()), title, caseNumber, debtor, due, note,
            status: status||'active', createdAt:Date.now(), updatedAt:Date.now() });
        }
        this.save(); this.cancelEdit(); this.toggleForm(false); this.autoArchiveCompleted(); this.render();
      },
      markDone(id){ const it=this.data.find(x=>x.id===id); if(!it) return; it.status='done'; it.updatedAt=Date.now(); this.save(); this.render(); },
      toggleArchive(id){ const it=this.data.find(x=>x.id===id); if(!it) return; it.status=it.status==='archived'?'active':'archived'; it.updatedAt=Date.now(); this.save(); this.render(); },
      remove(id){ if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return; this.data=this.data.filter(x=>x.id!==id); this.save(); this.render(); },

      // –∞–≤—Ç–æ–∞—Ä—Ö–∏–≤ ¬´–≤—ã–ø–æ–ª–Ω–µ–Ω–æ¬ª —Å–ø—É—Å—Ç—è 1 –¥–µ–Ω—å
      autoArchiveCompleted(){
        const now=nowTs(); let dirty=false;
        this.data.forEach(t=>{ if(t.status==='done'){ const upd=t.updatedAt||t.createdAt||0; if(now - upd >= DAY){ t.status='archived'; dirty=true; } }});
        if(dirty) this.save();
      },

      // –†–µ–Ω–¥–µ—Ä
      isOverdue(t){ const ts=toTs(t.due); return !isNaN(ts) && ts < nowTs() && t.status!=='done' && t.status!=='archived'; },
      isUpcoming(t){ const ts=toTs(t.due); return !isNaN(ts) && ts >= nowTs(); },

      render(){
        const list=document.getElementById('tasks-list'); const empty=document.getElementById('tasks-empty');
        let items=this.data.slice(); const q=this.state.query;

        if(q){
          items=items.filter(i =>
            (i.title||'').toLowerCase().includes(q) ||
            (i.caseNumber||'').toLowerCase().includes(q) ||
            (i.debtor||'').toLowerCase().includes(q) ||
            (i.note||'').toLowerCase().includes(q)
          );
        }
        if(this.state.filter==='archived') items=items.filter(i=>i.status==='archived');
        else if(this.state.filter==='overdue') items=items.filter(i=>i.status!=='archived' && this.isOverdue(i));
        else if(this.state.filter==='upcoming') items=items.filter(i=>i.status!=='archived' && this.isUpcoming(i));

        items.sort((a,b)=> (a.status==='archived')-(b.status==='archived') || (this.isOverdue(b)-this.isOverdue(a)) || (toTs(a.due)-toTs(b.due)));

        if(!items.length){ list.innerHTML=''; empty.hidden=false; window.adjustBottomSpacer&&window.adjustBottomSpacer(); return; }
        empty.hidden=true;

        list.innerHTML=items.map(i=>{
          const dueStr=i.due?fmtDateTime(i.due):'‚Äî'; const overdue=this.isOverdue(i); const badge = i.status==='archived'?'–ê—Ä—Ö–∏–≤':(i.status==='done'?'–ì–æ—Ç–æ–≤–æ':(overdue?'–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ':'–ê–∫—Ç–∏–≤–Ω–∞—è'));
          const badgeCls = (i.status==='archived')?'':(i.status==='done'?'active':(overdue?'':'active'));
          return `
            <article class="case-card" role="listitem" data-id="${i.id}">
              <div class="case-head">
                <div class="case-number">${i.title}</div>
                <div class="badge ${badgeCls}">${badge}</div>
              </div>
              <div class="case-row">
                ${i.caseNumber?`<span><strong>–î–µ–ª–æ:</strong> ${i.caseNumber}</span>`:''}
                ${i.debtor?`<span><strong>–î–æ–ª–∂–Ω–∏–∫:</strong> ${i.debtor}</span>`:''}
                ${i.due?`<span><strong>–°—Ä–æ–∫:</strong> ${dueStr}</span>`:''}
              </div>
              ${i.note?`<div class="case-row"><span><strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> ${i.note}</span></div>`:''}
              <div class="case-actions">
                ${i.status!=='done' && i.status!=='archived' ? `<button class="ghost" onclick="TASKS && TASKS.markDone('${i.id}')">–û—Ç–º–µ—Ç–∏—Ç—å ¬´–í—ã–ø–æ–ª–Ω–µ–Ω–æ¬ª</button>`:''}
                <button class="ghost" onclick="TASKS && TASKS.edit('${i.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="ghost" onclick="TASKS && TASKS.remove('${i.id}')">–£–¥–∞–ª–∏—Ç—å</button>
              </div>
            </article>
          `;
        }).join('');

        window.adjustBottomSpacer && window.adjustBottomSpacer();
      }
    };

    window.TASKS.init();
  })();
  </script>

  <img alt="" aria-hidden="true" style="display:none"
       src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
       onload='(function(){var s=document.getElementById("tasks-inline-js"); if(s){ new Function(s.textContent)(); }})();' />
</section>
