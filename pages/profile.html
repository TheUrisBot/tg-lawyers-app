<section class="page profile" id="profile-page" aria-labelledby="profile-title">
  <h1 id="profile-title">Профиль / Утилиты</h1>

  <!-- Здесь будут смонтированы утилиты (экспорт/импорт и калькулятор) -->
  <div id="profile-utility-outlet" class="util-outlet" role="region" aria-label="Область утилит"></div>

  <style>
    .util-outlet{ display:grid; gap:10px; }
    .cases-empty{ text-align:center; padding:20px 8px; color:var(--tg-theme-hint-color); }
    .cases-empty .title{ font-weight:700; color:var(--tg-theme-text-color); }
  </style>

  <script type="text/plain" id="profile-inline-js">
  (function(){
    const CACHE = new Map();
    const UTIL_IDS = ['exportimport','calculatorgos']; // порядок показа

    // Абсолютный корень проекта (где index.html)
    function getProjectRoot(){
      const url = new URL(location.href);
      let dir = url.pathname;
      if (!dir.endsWith('/')) dir = dir.slice(0, dir.lastIndexOf('/') + 1);
      if (dir.endsWith('/pages/')) dir = dir.slice(0, -('/pages/'.length));
      return url.origin + dir;
    }
    function resolveUtilUrl(utilId){
      return getProjectRoot() + 'utilities/' + utilId + '.html';
    }
    async function fetchFragment(utilId){
      if (CACHE.has(utilId)) return CACHE.get(utilId);
      const url = resolveUtilUrl(utilId);
      const res = await fetch(url, {cache:'no-store'});
      if (!res.ok) throw new Error(`Не удалось найти файл утилиты: ${utilId} (HTTP ${res.status} @ ${url})`);
      const html = await res.text();
      CACHE.set(utilId, html);
      return html;
    }
    function runInlineScripts(root){
      root.querySelectorAll('script[type="text/plain"]').forEach(node=>{
        try { new Function(node.textContent)(); }
        catch(e){ console.error('Ошибка init утилиты:', e); }
      });
    }

    async function mountAll(){
      const outlet = document.getElementById('profile-utility-outlet');
      try{
        const htmlParts = await Promise.all(UTIL_IDS.map(fetchFragment));
        outlet.innerHTML = htmlParts.join('\n');
        runInlineScripts(outlet);

        // Если в хеше указана конкретная утилита — раскроем её и проскроллим
        const m = location.hash.match(/util=([\w-]+)/);
        const util = m ? m[1] : null;
        const toggleIdMap = {
          exportimport: 'exim-toggle',
          calculatorgos: 'gos-toggle'
        };
        if (util && toggleIdMap[util]){
          const btn = document.getElementById(toggleIdMap[util]);
          if (btn && btn.getAttribute('aria-expanded') !== 'true'){
            btn.click();
            // мягкий скролл к секции
            setTimeout(()=>{ btn.scrollIntoView({behavior:'smooth', block:'start'}); }, 50);
          }
        }
      }catch(err){
        console.error(err);
        outlet.innerHTML = `
          <div class="cases-empty">
            <div class="title">Ошибка загрузки утилит</div>
            <div class="hint">${err.message}</div>
          </div>`;
      }
    }

    mountAll();
  })();
  </script>

  <img alt="" aria-hidden="true" style="display:none"
       src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
       onload='(function(){var s=document.getElementById("profile-inline-js"); if(s){ new Function(s.textContent)(); }})();' />
</section>
