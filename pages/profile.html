<section class="page profile" id="profile-page" aria-labelledby="profile-title">
  <h1 id="profile-title">–ü—Ä–æ—Ñ–∏–ª—å / –£—Ç–∏–ª–∏—Ç—ã</h1>

  <!-- –ú–µ–Ω—é —É—Ç–∏–ª–∏—Ç -->
  <div class="util-menu" role="tablist" aria-label="–°–ø–∏—Å–æ–∫ —É—Ç–∏–ª–∏—Ç">
    <button class="util-chip" role="tab" data-util="exportimport"
            onclick="PROFILE && PROFILE.open('exportimport')">
      –≠–∫—Å–ø–æ—Ä—Ç –∏ –∏–º–ø–æ—Ä—Ç –¥–µ–ª
    </button>
    <button class="util-chip" role="tab" data-util="calculatorgos"
            onclick="PROFILE && PROFILE.open('calculatorgos')">
      –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≥–æ—Å. –ø–æ—à–ª–∏–Ω—ã –¥–ª—è –∞—Ä–±–∏—Ç—Ä–∞–∂–Ω—ã—Ö —Å—É–¥–æ–≤
    </button>
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–¥—Å—Ç—Ä–∞–Ω–∏—Ü -->
  <div id="profile-utility-outlet" class="util-outlet" role="region" aria-label="–û–±–ª–∞—Å—Ç—å —É—Ç–∏–ª–∏—Ç"></div>

  <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
  <div id="profile-empty" class="cases-empty">
    <div class="emoji" aria-hidden="true">üß∞</div>
    <div class="title">–í—ã–±–µ—Ä–∏ —É—Ç–∏–ª–∏—Ç—É</div>
    <div class="hint">–ù–∞–∂–º–∏ –Ω–∞ –Ω—É–∂–Ω—É—é –≤–∫–ª–∞–¥–∫—É –≤—ã—à–µ.</div>
  </div>

  <style>
    .util-menu{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 6px; }
    .util-chip{ border:1px solid var(--separator); background:transparent; color:var(--tg-theme-text-color);
      padding:10px 12px; border-radius:999px; cursor:pointer; }
    .util-chip[aria-selected="true"], .util-chip.active{
      border-color:var(--app-accent); color:var(--app-accent); font-weight:600;
    }
    .util-outlet{ display:grid; gap:8px; }
    .cases-empty{ text-align:center; padding:20px 8px; color:var(--tg-theme-hint-color); }
    .cases-empty .emoji{ font-size:36px; margin-bottom:8px; }
    .cases-empty .title{ font-weight:700; color:var(--tg-theme-text-color); }
  </style>

  <script type="text/plain" id="profile-inline-js">
  (function(){
    const CACHE = new Map();

    function setActive(util){
      document.querySelectorAll('#profile-page .util-chip').forEach(btn=>{
        const on = btn.dataset.util === util;
        btn.classList.toggle('active', on);
        btn.setAttribute('aria-selected', String(on));
      });
    }

    // –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ (–≥–¥–µ index.html)
    function getProjectRoot(){
      const url = new URL(location.href);
      let dir = url.pathname;
      if (!dir.endsWith('/')) dir = dir.slice(0, dir.lastIndexOf('/') + 1);
      if (dir.endsWith('/pages/')) dir = dir.slice(0, -('/pages/'.length));
      return url.origin + dir;
    }
    function resolveUtilUrl(utilId){
      return getProjectRoot() + 'utilities/' + utilId + '.html';
    }
    async function loadFragment(utilId){
      if (CACHE.has(utilId)) return CACHE.get(utilId);
      const url = resolveUtilUrl(utilId);
      const res = await fetch(url, {cache:'no-store'});
      if (!res.ok) throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ñ–∞–π–ª —É—Ç–∏–ª–∏—Ç—ã: ${utilId} (HTTP ${res.status} @ ${url})`);
      const html = await res.text();
      CACHE.set(utilId, html);
      return html;
    }
    function runInlineScripts(root){
      root.querySelectorAll('script[type="text/plain"]').forEach(node=>{
        try { new Function(node.textContent)(); }
        catch(e){ console.error('–û—à–∏–±–∫–∞ init —É—Ç–∏–ª–∏—Ç—ã:', e); }
      });
    }

    window.PROFILE = {
      async open(utilId){
        const outlet = document.getElementById('profile-utility-outlet');
        const empty  = document.getElementById('profile-empty');
        setActive(utilId);
        empty.hidden = true;

        try{
          const html = await loadFragment(utilId);
          outlet.innerHTML = html;
          runInlineScripts(outlet);
          try { history.replaceState(null,'', '#util=' + utilId); } catch(_){}
        }catch(err){
          console.error(err);
          outlet.innerHTML = `
            <div class="cases-empty">
              <div class="title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
              <div class="hint">${err.message}</div>
            </div>`;
        }
      },
      init(){
        const m = location.hash.match(/util=([\w-]+)/);
        if (m) { this.open(m[1]); }
      }
    };

    window.PROFILE.init();
  })();
  </script>

  <img alt="" aria-hidden="true" style="display:none"
       src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
       onload='(function(){var s=document.getElementById("profile-inline-js"); if(s){ new Function(s.textContent)(); }})();' />
</section>
