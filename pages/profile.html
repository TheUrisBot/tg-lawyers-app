<section class="page profile" id="profile-page" aria-labelledby="profile-title">
  <h1 id="profile-title">Профиль / Утилиты</h1>

  <!-- Контейнер подстраниц -->
  <div id="profile-utility-outlet" class="util-outlet" role="region" aria-label="Область утилит"></div>

  <style>
    .util-outlet{ display:grid; gap:8px; }
  </style>

  <script type="text/plain" id="profile-inline-js">
  (function(){
    const CACHE = new Map();

    // Определяем абсолютный корень проекта (папка, где лежит index.html)
    function getProjectRoot(){
      const url = new URL(location.href);
      let dir = url.pathname;
      if (!dir.endsWith('/')) dir = dir.slice(0, dir.lastIndexOf('/') + 1);
      if (dir.endsWith('/pages/')) dir = dir.slice(0, -('/pages/'.length));
      return url.origin + dir; // например http://127.0.0.1:5500/tg-lawyers-app/
    }
    function resolveUtilUrl(utilId){
      return getProjectRoot() + 'utilities/' + utilId + '.html';
    }
    async function loadFragment(utilId){
      if (CACHE.has(utilId)) return CACHE.get(utilId);
      const url = resolveUtilUrl(utilId);
      const res = await fetch(url, {cache:'no-store'});
      if (!res.ok) throw new Error(`Не удалось найти файл утилиты: ${utilId} (HTTP ${res.status} @ ${url})`);
      const html = await res.text();
      CACHE.set(utilId, html);
      return html;
    }
    function runInlineScripts(root){
      root.querySelectorAll('script[type="text/plain"]').forEach(node=>{
        try { new Function(node.textContent)(); }
        catch(e){ console.error('Ошибка init утилиты:', e); }
      });
    }

    window.PROFILE = {
      async open(utilId){
        const outlet = document.getElementById('profile-utility-outlet');
        try{
          const html = await loadFragment(utilId);
          outlet.innerHTML = html;
          runInlineScripts(outlet);
          try { history.replaceState(null,'', '#util=' + utilId); } catch(_){}
        }catch(err){
          console.error(err);
          outlet.innerHTML = `
            <div class="cases-empty">
              <div class="title">Ошибка загрузки</div>
              <div class="hint">${err.message}</div>
            </div>`;
        }
      },
      init(){
        const m = location.hash.match(/util=([\w-]+)/);
        this.open(m ? m[1] : 'exportimport'); // по умолчанию открываем экспорт/импорт
      }
    };

    window.PROFILE.init();
  })();
  </script>

  <img alt="" aria-hidden="true" style="display:none"
       src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
       onload='(function(){var s=document.getElementById("profile-inline-js"); if(s){ new Function(s.textContent)(); }})();' />
</section>
