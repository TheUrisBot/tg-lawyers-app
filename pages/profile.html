<section class="page profile" id="profile-page" aria-labelledby="profile-title">
  <h1 id="profile-title">Профиль / Утилиты</h1>

  <!-- === УТИЛИТА: ЭКСПОРТ (аккордеон) === -->
  <div class="util-section" id="util-export">
    <button class="util-head" type="button" onclick="PROFILE && PROFILE.toggle('export')" aria-expanded="false">
      <span class="title">Экспорт дел</span>
      <span class="chev" aria-hidden="true">ˬ</span>
    </button>
    <div class="util-body collapse" aria-hidden="true">
      <div class="cases-form" role="region" aria-label="Экспорт дел">
        <div class="grid">
          <div style="grid-column:1 / -1; color:var(--tg-theme-hint-color); font-size:14px;">
            Выгружаем все дела из локального хранилища в Excel. Шаблон — совместимый с импортом.
          </div>
          <div class="form-actions" style="justify-content:flex-start; gap:8px;">
            <button class="primary" onclick="PROFILE && PROFILE.exportXLSX()">Экспорт в Excel (.xlsx)</button>
            <button class="ghost"   onclick="PROFILE && PROFILE.downloadTemplate()">Скачать шаблон Excel</button>
            <button class="ghost"   onclick="PROFILE && PROFILE.exportJSON()">Бэкап (JSON)</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- === УТИЛИТА: ИМПОРТ (аккордеон) === -->
  <div class="util-section" id="util-import" style="margin-top:10px;">
    <button class="util-head" type="button" onclick="PROFILE && PROFILE.toggle('import')" aria-expanded="false">
      <span class="title">Импорт дел</span>
      <span class="chev" aria-hidden="true">ˬ</span>
    </button>
    <div class="util-body collapse" aria-hidden="true">
      <div class="cases-form" role="region" aria-label="Импорт дел">
        <div class="grid">
          <div style="grid-column:1 / -1; color:var(--tg-theme-hint-color); font-size:14px;">
            Поддерживаем Excel (.xlsx) и CSV. При совпадении «Номер дела» запись <em>обновляется</em>, иначе — <em>создаётся</em>.
          </div>

          <label style="grid-column:1 / -1;">
            <span>Файл Excel/CSV</span>
            <input id="cases-file" type="file" accept=".xlsx,.csv" />
          </label>

          <div class="dropzone" id="import-dropzone" style="grid-column:1 / -1;">
            Перетащи файл сюда или выбери его выше
          </div>

          <div class="form-actions" style="justify-content:flex-start;">
            <button class="primary" onclick="PROFILE && PROFILE.importFile()">Импортировать</button>
            <button class="ghost"   onclick="PROFILE && PROFILE.showColumns()">Какие столбцы поддерживаются?</button>
          </div>

          <div id="import-result" class="import-result" style="grid-column:1 / -1;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Спейсер, чтобы ничего не пряталось под нижним баром -->
  <div class="list-spacer" id="profile-spacer" aria-hidden="true"></div>

  <!-- Стили -->
  <style>
    /* Аккордеон: шапка секции */
    .util-head{
      width:100%; display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 14px; border-radius:14px; border:1px solid var(--separator);
      background: var(--tg-theme-secondary-bg-color); color: var(--tg-theme-text-color);
      cursor:pointer;
    }
    .util-head .title{ font-weight:700; }
    .util-head .chev{
      display:inline-block; font-size:1.2em; line-height:1; min-width:1.2em; text-align:right;
      transition: transform 240ms ease, color 240ms ease;
    }
    .util-head[aria-expanded="true"] .chev{ transform: rotate(180deg); }
    .util-head:hover{ border-color: var(--app-accent); color: var(--app-accent); }

    /* Тело секции — плавное сворачивание */
    .collapse { max-height: 0; overflow: hidden; opacity: 0; transition: max-height 260ms ease, opacity 260ms ease; }
    .collapse.open { opacity: 1; }

    /* Блоки форм — общий стиль */
    .cases-form {
      border: 1px solid var(--separator); background: var(--tg-theme-secondary-bg-color);
      border-radius: 16px; padding: 12px; display: grid; gap: 12px; margin-top:8px;
      overflow-wrap: anywhere;
    }
    .cases-form .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .cases-form label { display: grid; gap: 6px; font-size: 12px; color: var(--tg-theme-hint-color); }
    .cases-form input {
      padding: 10px 12px; border-radius: 12px; border: 1px solid var(--separator);
      background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); outline: none;
    }
    .cases-form input:focus { border-color: var(--app-accent); }
    .form-actions { display: flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap; }
    .primary, .ghost {
      appearance: none; border: 1px solid transparent; padding: 10px 12px; border-radius: 12px; cursor: pointer;
      background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color);
    }
    .ghost { background: transparent; border-color: var(--separator); color: var(--tg-theme-text-color); }

    /* Dropzone */
    .dropzone {
      border: 1px dashed var(--separator); border-radius: 12px; padding: 18px; text-align: center;
      color: var(--tg-theme-hint-color);
    }
    .dropzone.drag { border-color: var(--app-accent); color: var(--app-accent); }

    /* Результат импорта + <details> */
    .import-result{ font-size:14px; color:var(--tg-theme-hint-color); overflow-wrap:anywhere; }
    .import-result details { margin-top: 6px; }
    .import-result summary { cursor: pointer; }

    /* Подстраховка: чтобы нижний бар не перекрывал интерфейс */
    .list-spacer { height: 16px; }

    @media (max-width: 520px) {
      .cases-form .grid { grid-template-columns: 1fr; }
    }
  </style>

  <!-- ВНИМАНИЕ: XLSX грузим лениво в JS ниже (без статического <script src=...>) -->

  <!-- Логика -->
  <script type="text/plain" id="profile-inline-js">
  (function () {
    const CASES_KEY = 'tl_cases_v1';

    /* ===== Ленивый загрузчик XLSX с двумя CDN и таймаутом ===== */
    const XLSX_URLS = [
      'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
      'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js'
    ];
    function ensureXLSX(timeoutMs = 8000){
      return new Promise((resolve, reject) => {
        if (window.XLSX) return resolve(window.XLSX);
        let i = 0, timer = null;
        const tryNext = () => {
          if (i >= XLSX_URLS.length) return reject(new Error('Не удалось загрузить библиотеку XLSX (CDN недоступны).'));
          const s = document.createElement('script');
          s.src = XLSX_URLS[i++]; s.async = true; s.crossOrigin = 'anonymous';
          s.onload = () => { clearTimeout(timer); window.XLSX ? resolve(window.XLSX) : reject(new Error('XLSX не инициализировалась')); };
          s.onerror = () => { clearTimeout(timer); s.remove(); tryNext(); };
          document.head.appendChild(s);
          timer = setTimeout(() => { s.remove(); tryNext(); }, timeoutMs);
        };
        tryNext();
      });
    }

    function nowStr() {
      const d = new Date(); const pad = n => (n<10 ? '0'+n : ''+n);
      return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate());
    }
    function readCases() {
      try { const raw = localStorage.getItem(CASES_KEY); const arr = raw ? JSON.parse(raw) : []; return Array.isArray(arr) ? arr : []; }
      catch(_) { return []; }
    }
    function saveCases(arr) { localStorage.setItem(CASES_KEY, JSON.stringify(arr || [])); }
    function uid(){ return String(Date.now()) + '-' + Math.random().toString(36).slice(2,7); }

    const COLS = {
      number: ['номер дела','номер','дело','case','case number','№ дела'],
      debtor: ['должник','debtor'],
      inn:    ['инн','inn'],
      court:  ['суд','court'],
      note:   ['примечание','заметка','note','comment'],
      status: ['статус','status']
    };
    const CANON_HEADERS = ['Номер дела','Должник','ИНН','Суд','Примечание','Статус'];

    function headerToKey(h){ if (!h) return null; const s=String(h).trim().toLowerCase();
      for (const k of Object.keys(COLS)) if (COLS[k].some(a=>a===s)) return k; return null; }

    function buildAOA(cases){
      const header = CANON_HEADERS.slice();
      const rows = cases.map(c => [c.number||'', c.debtor||'', c.inn||'', c.court||'', c.note||'', c.status||'active']);
      return [header, ...rows];
    }

    function writeWorkbook(aoa,name){
      const ws=XLSX.utils.aoa_to_sheet(aoa); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Дела'); XLSX.writeFile(wb,name);
    }

    function parseSheetToObjects(sheet){
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
      if (!rows.length) return [];
      const headers = rows[0].map(h => headerToKey(h));
      const out = [];
      for (let r=1;r<rows.length;r++){
        const row = rows[r]; const obj = {};
        headers.forEach((key,i)=>{ if(!key) return; const val=row[i]; obj[key]=(val==null? '': String(val).trim()); });
        const num = (obj.number||'').trim(); if (!num) continue;
        if (!obj.status) obj.status='active';
        out.push(obj);
      }
      return out;
    }

    function mergeCases(existing, imported){
      const index = new Map(); existing.forEach(c=>{ if(c&&c.number) index.set(String(c.number).trim(), c); });
      let added=0, updated=0; const affected=[];
      imported.forEach(nc=>{
        const key=String(nc.number).trim(); const prev=index.get(key);
        if (prev){
          prev.debtor=nc.debtor ?? prev.debtor;
          prev.inn   =nc.inn    ?? prev.inn;
          prev.court =nc.court  ?? prev.court;
          prev.note  =nc.note   ?? prev.note;
          prev.status=nc.status || prev.status || 'active';
          prev.updatedAt=Date.now(); updated++; affected.push({type:'upd', number:key});
        } else {
          const nu={ id:uid(), number:key, debtor:nc.debtor||'', inn:nc.inn||'', court:nc.court||'', note:nc.note||'',
                     status:(nc.status==='archived'?'archived':'active'), createdAt:Date.now(), updatedAt:Date.now() };
          existing.push(nu); index.set(key,nu); added++; affected.push({type:'add', number:key});
        }
      });
      return {added,updated,affected};
    }

    /* === Пересчёт высоты открытых аккордеонов (в т.ч. при toggle <details>) === */
    function fixOpenHeights(){
      document.querySelectorAll('.util-body.collapse.open').forEach(body=>{
        body.style.maxHeight = body.scrollHeight + 'px';
      });
      window.adjustBottomSpacer && window.adjustBottomSpacer();
    }
    // подписываем <details> внутри контейнера на пересчёт
    function wireDetailsAutoResize(container){
      if (!container) return;
      container.querySelectorAll('details').forEach(d => {
        if (!d._wiredToggle) {
          d.addEventListener('toggle', fixOpenHeights);
          d._wiredToggle = true;
        }
      });
    }
    // безопасный ререндер вкладки «Дела», только если её DOM на странице
    function safeRenderCases(){
      const hasDom = document.getElementById('cases-list') && document.getElementById('cases-empty');
      if (hasDom && window.CASES && typeof window.CASES.render === 'function') {
        try { window.CASES.render(); } catch(_) { /* игнорируем */ }
      }
    }

    function showResult(html){
      const box=document.getElementById('import-result');
      if (box) {
        box.innerHTML=html;
        wireDetailsAutoResize(box);   // <details> будет корректно менять высоту секции
      }
      fixOpenHeights();               // сразу подстроим аккордеон
    }

    function setupDropzone(){
      const dz=document.getElementById('import-dropzone'); const input=document.getElementById('cases-file'); if(!dz||!input) return;
      ['dragenter','dragover'].forEach(evt=>dz.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dz.classList.add('drag');}));
      ['dragleave','drop'].forEach(evt=>dz.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dz.classList.remove('drag');}));
      dz.addEventListener('drop',e=>{
        const files=e.dataTransfer?.files; if(files&&files.length){ input.files=files;
          showResult('Файл выбран: <strong>'+files[0].name+'</strong>. Нажми «Импортировать».'); }
      });
    }

    // Резервный парсер CSV (без XLSX) — на случай, если сеть недоступна
    function parseCSVText(text){
      const firstLine = (text.split(/\r?\n/)[0] || '');
      const delimiter = (firstLine.match(/;/g)||[]).length >= (firstLine.match(/,/g)||[]).length
                        ? (firstLine.includes(';') ? ';' : (firstLine.includes('\t') ? '\t' : ','))
                        : ',';
      const lines = text.replace(/\r/g,'').split('\n').filter(l => l.trim().length);
      if (!lines.length) return [];
      const headers = lines[0].split(delimiter).map(h => headerToKey(h));
      const out = [];
      for (let i=1;i<lines.length;i++){
        const cols = lines[i].split(delimiter);
        const obj = {};
        headers.forEach((key, idx) => { if (!key) return; obj[key] = (cols[idx]||'').trim(); });
        const num = (obj.number||'').trim(); if (!num) continue;
        if (!obj.status) obj.status = 'active';
        out.push(obj);
      }
      return out;
    }

    window.PROFILE = {
      toggle(which, force){
        const id = which==='export' ? 'util-export' : 'util-import';
        const sec = document.getElementById(id); if(!sec) return;
        const head = sec.querySelector('.util-head'); const body = sec.querySelector('.util-body');
        const isOpen = body.classList.contains('open'); const shouldOpen = (typeof force==='boolean') ? force : !isOpen;
        if (shouldOpen===isOpen) return;

        body.style.overflow='hidden';
        if (shouldOpen){
          body.classList.add('open'); body.style.maxHeight = body.scrollHeight + 'px';
          head.setAttribute('aria-expanded','true'); body.setAttribute('aria-hidden','false');
        } else {
          body.style.maxHeight = body.scrollHeight + 'px';
          requestAnimationFrame(()=>{ body.style.maxHeight='0px'; });
          head.setAttribute('aria-expanded','false'); body.setAttribute('aria-hidden','true');
          body.addEventListener('transitionend', ()=>{ body.classList.remove('open'); }, {once:true});
        }
        setTimeout(fixOpenHeights, 300);
      },

      async exportXLSX(){
        try{
          await ensureXLSX();
          const data=readCases(); const aoa=buildAOA(data); const name='cases_'+nowStr()+'.xlsx';
          writeWorkbook(aoa,name);
        }catch(e){
          alert('Не удалось загрузить библиотеку XLSX для экспорта.\n'+(e?.message||e));
        }
      },

      async downloadTemplate(){
        try{
          await ensureXLSX();
          const aoa=[CANON_HEADERS]; const name='cases_template.xlsx';
          writeWorkbook(aoa,name);
        }catch(e){
          alert('Не удалось загрузить библиотеку XLSX для шаблона.\n'+(e?.message||e));
        }
      },

      exportJSON(){
        const data=readCases();
        const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json;charset=utf-8'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download='cases_backup_'+nowStr()+'.json';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      },

      showColumns(){
        const cols = ['Номер дела','Должник','ИНН','Суд','Примечание','Статус'].map(c=>'• '+c).join('<br>');
        showResult('<div><strong>Поддерживаемые столбцы:</strong><br>'+cols+'<br><br><em>Мин. обязательный — «Номер дела».</em></div>');
      },

      async importFile(){
        const input=document.getElementById('cases-file'); const file=input&&input.files&&input.files[0];
        if(!file){ alert('Выбери файл .xlsx или .csv'); return; }

        const isCSV=/\.csv$/i.test(file.name);
        let xlsxReady = false;
        try { await ensureXLSX(); xlsxReady = true; } catch(_) { xlsxReady = false; }

        const reader=new FileReader();
        reader.onload=async (e)=>{
          try{
            const existing=readCases();
            let rowsObjs=[];

            if (xlsxReady) {
              if (isCSV) {
                const data = e.target.result;
                const wb = XLSX.read(typeof data === 'string' ? data : new Uint8Array(data), { type: typeof data === 'string' ? 'binary' : 'array' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                rowsObjs = (window.parseSheetToObjects || parseSheetToObjects)(ws);
              } else {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, { type: 'array' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                rowsObjs = (window.parseSheetToObjects || parseSheetToObjects)(ws);
              }
            } else {
              if (!isCSV) {
                alert('Для импорта .xlsx требуется сеть (загрузка библиотеки XLSX не удалась). Сохрани файл как CSV и повтори.');
                return;
              }
              const text = typeof e.target.result === 'string' ? e.target.result : new TextDecoder('utf-8').decode(e.target.result);
              rowsObjs = parseCSVText(text);
            }

            if(!rowsObjs.length){ showResult('Не найдено валидных строк. Убедись, что есть заголовки и заполнен «Номер дела».'); return; }
            const {added,updated,affected}=mergeCases(existing,rowsObjs); saveCases(existing);

            const msg = `
              <div>
                <strong>Импорт завершён</strong><br>
                Добавлено: <strong>${added}</strong><br>
                Обновлено: <strong>${updated}</strong><br>
                Всего в базе: <strong>${existing.length}</strong>
              </div>
              <details>
                <summary>Показать список затронутых дел</summary>
                <div style="margin-top:6px; max-height:160px; overflow:auto;">
                  ${affected.map(x => `<div>${x.type === 'add' ? '➕' : '✏️'} ${x.number}</div>`).join('')}
                </div>
              </details>
            `;
            showResult(msg);

            // безопасно обновим вкладку «Дела», если она смонтирована
            safeRenderCases();
          } catch(err){
            console.error(err);
            alert('Ошибка импорта: '+(err?.message||err));
          }
        };

        if (xlsxReady) {
          if (isCSV) reader.readAsBinaryString(file);
          else reader.readAsArrayBuffer(file);
        } else {
          reader.readAsText(file, 'utf-8');
        }
      },

      // экспортируем для отладочного вызова
      fixOpenHeights
    };

    // Инициализация
    document.addEventListener('DOMContentLoaded', ()=>{
      setupDropzone();
      window.addEventListener('resize', PROFILE.fixOpenHeights);
      window.adjustBottomSpacer && window.adjustBottomSpacer();
    });
  })();
  </script>

  <!-- Триггер запуска логики выше -->
  <img alt="" aria-hidden="true" style="display:none"
       src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
       onload='(function(){var s=document.getElementById("profile-inline-js"); if(s){ new Function(s.textContent)(); }})();' />
</section>
