<section class="page" aria-labelledby="hearings-title">
  <h1 id="hearings-title">Заседания</h1>

  <!-- Форма создания/редактирования заседания -->
  <div class="card">
    <form id="hearing-form">
      <div style="display:grid; gap:8px;">

        <!-- Выбор дела из локально сохранённых -->
        <div style="display:grid; gap:4px;">
          <label for="h_caseId">Дело *</label>
          <select id="h_caseId" name="caseId" required>
            <option value="">Выберите дело…</option>
          </select>
          <div id="h_caseHint" style="font-size:12px; color:var(--muted); display:none;"></div>
        </div>

        <div style="display:grid; gap:4px;">
          <label for="h_date">Дата заседания *</label>
          <input id="h_date" name="date" type="date" required />
        </div>

        <div style="display:grid; gap:4px;">
          <label for="h_time">Время</label>
          <input id="h_time" name="time" type="time" />
        </div>

        <div style="display:grid; gap:4px;">
          <label for="h_court">Суд / зал</label>
          <input id="h_court" name="court" type="text" placeholder="АС г. Москвы, зал 305" />
        </div>

        <div style="display:grid; gap:4px;">
          <label for="h_judge">Судья</label>
          <input id="h_judge" name="judge" type="text" placeholder="Иванов И.И." />
        </div>

        <div style="display:grid; gap:4px;">
          <label for="h_status">Статус</label>
          <select id="h_status" name="status">
            <option value="">—</option>
            <option value="scheduled">Назначено</option>
            <option value="postponed">Перенесено</option>
            <option value="canceled">Отменено</option>
            <option value="held">Состоялось</option>
          </select>
        </div>

        <div style="display:grid; gap:4px;">
          <label for="h_note">Примечание</label>
          <textarea id="h_note" name="note" rows="3" placeholder="Короткая заметка"></textarea>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:4px">
          <button type="submit" style="border:1px solid var(--divider); border-radius:10px; padding:8px 12px; background:transparent; color:var(--fg); cursor:pointer;">
            Сохранить заседание
          </button>
          <button type="button" id="h_reset" style="border:1px solid var(--divider); border-radius:10px; padding:8px 12px; background:transparent; color:var(--fg); cursor:pointer;">
            Очистить форму
          </button>
        </div>

        <!-- скрытое поле для режима редактирования -->
        <input type="hidden" id="h_editingId" />
      </div>
    </form>
  </div>

  <!-- Поиск и список заседаний -->
  <div class="card">
    <div style="display:grid; gap:8px;">
      <input id="h_search" type="search" placeholder="Поиск по № делу / должнику / судье / залу" />
      <div id="h_empty" style="display:none; color:var(--muted);">Пока нет заседаний. Добавьте первое выше.</div>
      <div id="hearings-list" style="display:grid; gap:8px;"></div>
    </div>
  </div>
</section>

<script>
(function () {
  const STORAGE_KEY = "hearings:list:v1";
  const CASES_KEY   = "cases:list:v1";

  const form = document.getElementById("hearing-form");
  const editingIdEl = document.getElementById("h_editingId");
  const listEl = document.getElementById("hearings-list");
  const emptyEl = document.getElementById("h_empty");
  const searchEl = document.getElementById("h_search");

  const caseSelect = document.getElementById("h_caseId");
  const caseHint   = document.getElementById("h_caseHint");

  const f = {
    caseId: caseSelect,
    date:   document.getElementById("h_date"),
    time:   document.getElementById("h_time"),
    court:  document.getElementById("h_court"),
    judge:  document.getElementById("h_judge"),
    status: document.getElementById("h_status"),
    note:   document.getElementById("h_note"),
  };

  // ---- Работа с делами (из другой вкладки) ----
  function loadCases() {
    try {
      const raw = localStorage.getItem(CASES_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch { return []; }
  }
  function getCaseById(id) {
    return loadCases().find(c => c.id === id);
  }
  function caseLabel(c) {
    const cn = c.caseNumber || "Без номера";
    const dn = c.debtorName ? ` — ${c.debtorName}` : "";
    return `${cn}${dn}`;
  }
  function populateCaseSelect(selectedId) {
    const cases = loadCases()
      .slice()
      .sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0));
    caseSelect.innerHTML = '<option value="">Выберите дело…</option>';
    cases.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = caseLabel(c);
      if (selectedId && selectedId === c.id) opt.selected = true;
      caseSelect.appendChild(opt);
    });

    if (!cases.length) {
      caseHint.style.display = "block";
      caseHint.textContent = "Нет дел. Откройте вкладку «Дела» и добавьте хотя бы одно.";
      caseSelect.disabled = true;
    } else {
      caseHint.style.display = "none";
      caseSelect.disabled = false;
    }
  }

  // --- Хранилище заседаний ---
  function loadAll() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch { return []; }
  }
  function saveAll(items) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
  }

  // --- Помощники ---
  function uid() {
    return "h_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
  }
  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }
  function statusLabel(v) {
    switch (v) {
      case "scheduled": return "Назначено";
      case "postponed": return "Перенесено";
      case "canceled":  return "Отменено";
      case "held":      return "Состоялось";
      default:          return "—";
    }
  }
  function toISO(dateStr, timeStr) {
    if (!dateStr) return null;
    const t = timeStr && /^\d{2}:\d{2}$/.test(timeStr) ? timeStr : "00:00";
    return `${dateStr}T${t}`;
  }
  function formatDateTime(isoLocal) {
    if (!isoLocal) return "—";
    try {
      const [d, t=""] = isoLocal.split("T");
      const [y,m,day] = d.split("-").map(Number);
      const [hh="00",mm="00"] = t.split(":");
      return `${String(day).padStart(2,"0")}.${String(m).padStart(2,"0")}.${y}${t ? " " + hh + ":" + mm : ""}`;
    } catch { return isoLocal; }
  }

  // --- Рендер списка ---
  function render(filter = "") {
    const q = filter.trim().toLowerCase();
    const items = loadAll();

    const filtered = q
      ? items.filter(it => {
          const c = getCaseById(it.caseId) || { caseNumber: it.caseNumber || "", debtorName: it.debtorName || "" };
          return (c.caseNumber || "").toLowerCase().includes(q) ||
                 (c.debtorName || "").toLowerCase().includes(q) ||
                 (it.judge || "").toLowerCase().includes(q) ||
                 (it.court || "").toLowerCase().includes(q);
        })
      : items;

    listEl.innerHTML = "";
    emptyEl.style.display = filtered.length ? "none" : "block";

    filtered
      .slice()
      .sort((a, b) => {
        const av = a.when || "";
        const bv = b.when || "";
        if (av && bv) return av.localeCompare(bv) || (b.updatedAt - a.updatedAt);
        if (av) return -1;
        if (bv) return 1;
        return (b.updatedAt - a.updatedAt);
      })
      .forEach(it => {
        const linkedCase = getCaseById(it.caseId);
        const label = linkedCase ? caseLabel(linkedCase)
                                 : (it.caseNumber || it.debtorName ? `${it.caseNumber || "Без номера"}${it.debtorName ? " — " + it.debtorName : ""}` : "Дело не найдено");

        const card = document.createElement("div");
        card.style.border = "1px solid var(--divider)";
        card.style.borderRadius = "12px";
        card.style.padding = "10px";
        card.style.background = "var(--surface)";
        card.style.display = "grid";
        card.style.gap = "6px";

        const title = document.createElement("div");
        title.style.display = "flex";
        title.style.justifyContent = "space-between";
        title.style.gap = "8px";
        title.style.alignItems = "baseline";
        title.innerHTML = `
          <div style="font-weight:600">${escapeHtml(label)}</div>
          <div style="font-size:12px; color:var(--muted)">${it.status ? escapeHtml(statusLabel(it.status)) : ""}</div>
        `;

        const meta = document.createElement("div");
        meta.style.fontSize = "14px";
        meta.style.color = "var(--fg)";
        meta.innerHTML = `
          <div><strong>Когда:</strong> ${escapeHtml(formatDateTime(it.when))}</div>
          ${it.court ? `<div><strong>Суд/зал:</strong> ${escapeHtml(it.court)}</div>` : ""}
          ${it.judge ? `<div><strong>Судья:</strong> ${escapeHtml(it.judge)}</div>` : ""}
          ${!linkedCase && (it.caseNumber || it.debtorName) ? `<div style="color:var(--muted)">Привязано к делу (снимок): ${escapeHtml((it.caseNumber || "Без номера") + (it.debtorName ? " — " + it.debtorName : ""))}</div>` : ""}
          ${!linkedCase && !(it.caseNumber || it.debtorName) ? `<div style="color:var(--muted)">Внимание: исходное дело было удалено.</div>` : ""}
          ${it.note ? `<div style="color:var(--muted)">${escapeHtml(it.note)}</div>` : ""}
        `;

        const actions = document.createElement("div");
        actions.style.display = "flex";
        actions.style.gap = "8px";
        actions.style.marginTop = "4px";

        const editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.dataset.action = "edit";
        editBtn.dataset.id = it.id;
        editBtn.style.border = "1px solid var(--divider)";
        editBtn.style.borderRadius = "10px";
        editBtn.style.padding = "6px 10px";
        editBtn.style.background = "transparent";
        editBtn.style.color = "var(--fg)";
        editBtn.style.cursor = "pointer";
        editBtn.textContent = "Редактировать";

        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.dataset.action = "delete";
        delBtn.dataset.id = it.id;
        delBtn.style.border = "1px solid var(--divider)";
        delBtn.style.borderRadius = "10px";
        delBtn.style.padding = "6px 10px";
        delBtn.style.background = "transparent";
        delBtn.style.color = "var(--fg)";
        delBtn.style.cursor = "pointer";
        delBtn.textContent = "Удалить";

        actions.append(editBtn, delBtn);
        card.append(title, meta, actions);
        listEl.appendChild(card);
      });
  }

  // Делегирование кликов на списке
  listEl.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-action]");
    if (!btn) return;
    const id = btn.dataset.id;
    const action = btn.dataset.action;
    if (action === "edit") loadIntoForm(id);
    else if (action === "delete") removeHearing(id);
  });

  // --- CRUD ---
  form.addEventListener("submit", (e) => {
    e.preventDefault();

    const caseId = f.caseId.value.trim();
    if (!caseId) {
      alert("Выберите дело.");
      return;
    }
    const linked = getCaseById(caseId);
    if (!linked) {
      alert("Выбранное дело не найдено. Обновите список дел.");
      return;
    }

    const data = {
      caseId,
      // Снимок (на случай удаления/изменения дела в будущем)
      caseNumber: linked.caseNumber || "",
      debtorName: linked.debtorName || "",

      date:   f.date.value,
      time:   f.time.value,
      court:  f.court.value.trim(),
      judge:  f.judge.value.trim(),
      status: f.status.value,
      note:   f.note.value.trim(),
    };

    if (!data.date) {
      alert("Укажите дату заседания.");
      return;
    }

    const id = editingIdEl.value || uid();
    const now = Date.now();
    const items = loadAll();
    const idx = items.findIndex(x => x.id === id);

    const when = toISO(data.date, data.time);
    const record = { id, ...data, when, updatedAt: now, createdAt: items[idx]?.createdAt || now };

    if (idx >= 0) items[idx] = record;
    else items.push(record);

    saveAll(items);
    clearForm();
    render(searchEl.value);
  });

  document.getElementById("h_reset").addEventListener("click", clearForm);

  function clearForm() {
    form.reset();
    editingIdEl.value = "";
    populateCaseSelect(); // восстановить список дел и выбор
  }

  function loadIntoForm(id) {
    const it = loadAll().find(x => x.id === id);
    if (!it) return;

    populateCaseSelect(it.caseId); // заполнить список и выбрать дело
    f.date.value   = it.date || "";
    f.time.value   = it.time || "";
    f.court.value  = it.court || "";
    f.judge.value  = it.judge || "";
    f.status.value = it.status || "";
    f.note.value   = it.note || "";
    editingIdEl.value = it.id;

    form.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  function removeHearing(id) {
    if (!confirm("Удалить заседание?")) return;
    const items = loadAll().filter(x => x.id !== id);
    saveAll(items);
    if (editingIdEl.value === id) clearForm();
    render(searchEl.value);
  }

  // Поиск
  searchEl.addEventListener("input", () => render(searchEl.value));

  // Первичный наполнение select делами + рендер
  populateCaseSelect();
  render();
})();
</script>
