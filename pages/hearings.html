<section class="page hearings" id="hearings-page" aria-labelledby="hearings-title">
  <h1 id="hearings-title">–ó–∞—Å–µ–¥–∞–Ω–∏—è</h1>

  <!-- –ü–∞–Ω–µ–ª—å -->
  <div class="cases-toolbar" role="region" aria-label="–ü–æ–∏—Å–∫ –∏ –¥–µ–π—Å—Ç–≤–∏—è">
    <div class="cases-search">
      <input id="hearings-search-input" type="search" placeholder="–ù–æ–º–µ—Ä –¥–µ–ª–∞, –¥–æ–ª–∂–Ω–∏–∫, —Å—É–¥, –∑–∞–ª, –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ"
             aria-label="–ü–æ–∏—Å–∫ –ø–æ –∑–∞—Å–µ–¥–∞–Ω–∏—è–º" oninput="HEARINGS && HEARINGS.setQuery(this.value)" />
      <button class="ghost" aria-label="–û—á–∏—Å—Ç–∏—Ç—å"
              onclick="HEARINGS && HEARINGS.setQuery(''); const i=document.getElementById('hearings-search-input'); i.value=''; i.focus();">‚úï</button>
    </div>
    <button class="primary" id="hearings-add-btn" aria-expanded="false" onclick="HEARINGS && HEARINGS.toggleForm()">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>

  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <div class="cases-filters" role="tablist" aria-label="–§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É">
    <button role="tab" class="chip active" data-filter="all" onclick="HEARINGS && HEARINGS.setFilter('all')">–í—Å–µ</button>
    <button role="tab" class="chip" data-filter="upcoming" onclick="HEARINGS && HEARINGS.setFilter('upcoming')">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ</button>
    <button role="tab" class="chip" data-filter="past" onclick="HEARINGS && HEARINGS.setFilter('past')">–ü—Ä–æ—à–µ–¥—à–∏–µ</button>
    <button role="tab" class="chip" data-filter="archived" onclick="HEARINGS && HEARINGS.setFilter('archived')">–ê—Ä—Ö–∏–≤</button>
  </div>

  <!-- –§–æ—Ä–º–∞ –ù–ê–î –∫–∞–ª–µ–Ω–¥–∞—Ä—ë–º -->
  <div id="hearings-form-wrap" class="collapse" aria-hidden="true" style="margin-top:10px;">
    <form id="hearings-form" class="cases-form" onsubmit="HEARINGS && HEARINGS.submit(event)">
      <div class="grid">
        <!-- –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ -->
        <label class="has-suggest" style="grid-column: 1 / -1;">
          <span>–î–µ–ª–æ (–Ω–æ–º–µ—Ä –∏–ª–∏ –¥–æ–ª–∂–Ω–∏–∫) *</span>
          <input type="text" id="h-combo" placeholder="–ê40-12345/2025 –∏–ª–∏ –ò–≤–∞–Ω–æ–≤ –ò.–ò. / –û–û–û ¬´–†–æ–≥–∞ –∏ –ö–æ–ø—ã—Ç–∞¬ª" autocomplete="off" />
          <div id="h-combo-suggest" class="suggest" role="listbox" hidden></div>
          <!-- —Å–∫—Ä—ã—Ç—ã–µ ¬´—Å—Ç–∞—Ä—ã–µ¬ª –ø–æ–ª—è -->
          <input type="hidden" id="h-case" />
          <input type="hidden" id="h-debtor" />
        </label>

        <!-- –§–æ—Ä–º–∞—Ç –∫–∞–∫ –≤ tasks.html -->
        <label>
          <span>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è *</span>
          <input type="datetime-local" id="h-datetime" required />
        </label>

        <label>
          <span>–°—É–¥</span>
          <input type="text" id="h-court" placeholder="–ê–° –≥. –ú–æ—Å–∫–≤—ã" />
        </label>
        <label>
          <span>–ó–∞–ª / –ê–¥—Ä–µ—Å</span>
          <input type="text" id="h-place" placeholder="–ó–∞–ª 314 / —É–ª. –ü—Ä–∏–º–µ—Ä, 1" />
        </label>
        <label style="grid-column: 1 / -1;">
          <span>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</span>
          <textarea id="h-note" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ –∑–∞—Å–µ–¥–∞–Ω–∏—é"></textarea>
        </label>
        <label>
          <span>–°—Ç–∞—Ç—É—Å</span>
          <select id="h-status">
            <option value="active" selected>–ê–∫—Ç–∏–≤–Ω–æ–µ</option>
            <option value="archived">–ê—Ä—Ö–∏–≤</option>
          </select>
        </label>
      </div>
      <div class="form-actions">
        <button type="button" class="ghost" onclick="HEARINGS && HEARINGS.toggleForm(false)">–°–≤–µ—Ä–Ω—É—Ç—å</button>
        <button type="submit" class="primary" id="hearings-submit-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>

  <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
  <div id="hearings-calendar" class="cal" aria-label="–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞—Å–µ–¥–∞–Ω–∏–π (–º–µ—Å—è—Ü)"></div>

  <!-- –ü–ª–∞—à–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã -->
  <div id="hearings-day-chip" class="day-chip" hidden>
    <span id="hearings-day-label"></span>
    <button class="ghost small" onclick="HEARINGS && HEARINGS.clearSelectedDay()" aria-label="–°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É">–°–±—Ä–æ—Å–∏—Ç—å</button>
  </div>

  <!-- –°–ø–∏—Å–æ–∫ –∑–∞—Å–µ–¥–∞–Ω–∏–π -->
  <div id="hearings-list" class="cases-list" role="list"></div>
  <div class="list-spacer" aria-hidden="true"></div>

  <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
  <div id="hearings-empty" class="cases-empty" hidden>
    <div class="emoji" aria-hidden="true">üóìÔ∏è</div>
    <div class="title">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞—Å–µ–¥–∞–Ω–∏–π</div>
    <div class="hint">–î–æ–±–∞–≤—å –∑–∞—Å–µ–¥–∞–Ω–∏–µ: —É–∫–∞–∂–∏ –¥–µ–ª–æ –∏ –¥–∞—Ç—É/–≤—Ä–µ–º—è.</div>
    <button class="primary" onclick="HEARINGS && HEARINGS.toggleForm(true)">–î–æ–±–∞–≤–∏—Ç—å –∑–∞—Å–µ–¥–∞–Ω–∏–µ</button>
  </div>

  <style>
    .cases-toolbar{ display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; }
    .cases-search{ display:grid; grid-template-columns:1fr auto; gap:6px; }
    .cases-search input{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--separator);
      background:var(--tg-theme-secondary-bg-color); color:var(--tg-theme-text-color); outline:none; }
    .cases-search input:focus{ border-color:var(--app-accent); }
    .cases-filters{ display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .chip{ border:1px solid var(--separator); background:transparent; color:var(--tg-theme-text-color);
      padding:6px 10px; border-radius:999px; cursor:pointer; }
    .chip.active{ border-color:var(--app-accent); color:var(--app-accent); font-weight:600; }

    .collapse{ max-height:0; overflow:hidden; opacity:0; transition:max-height 240ms ease, opacity 240ms ease; }
    .collapse.open{ opacity:1; }

    .cases-form{ border:1px solid var(--separator); background:var(--tg-theme-secondary-bg-color);
      border-radius:16px; padding:12px; display:grid; gap:12px; margin-top:8px; }
    .cases-form .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .cases-form label{ display:grid; gap:6px; font-size:12px; color:var(--tg-theme-hint-color); }
    .cases-form input,.cases-form select,.cases-form textarea{
      padding:10px 12px; border-radius:12px; border:1px solid var(--separator);
      background:var(--tg-theme-bg-color); color:var(--tg-theme-text-color); outline:none; resize:vertical;
    }
    .cases-form input:focus,.cases-form select:focus,.cases-form textarea:focus{ border-color:var(--app-accent); }
    .form-actions{ display:flex; gap:8px; justify-content:flex-end; }
    .primary,.ghost{ appearance:none; border:1px solid transparent; padding:10px 12px; border-radius:12px; cursor:pointer;
      background:var(--tg-theme-button-color); color:var(--tg-theme-button-text-color); }
    .ghost{ background:transparent; border-color:var(--separator); color:var(--tg-theme-text-color); }

    .has-suggest{ position:relative; }
    .suggest{ position:absolute; top:100%; left:0; right:0; z-index:10; background:var(--tg-theme-bg-color);
      border:1px solid var(--separator); border-radius:12px; margin-top:6px; max-height:220px; overflow:auto;
      box-shadow:0 6px 24px rgba(0,0,0,.25); }
    .suggest-item{ padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; gap:12px; }
    .suggest-item:hover, .suggest-item[aria-selected="true"]{ background:var(--tg-theme-secondary-bg-color); }
    .suggest-item .hint{ color:var(--tg-theme-hint-color); font-size:12px; }

    .cal{ border:1px solid var(--separator); border-radius:16px; background:var(--tg-theme-secondary-bg-color); padding:10px; display:grid; gap:8px; margin-top:8px; }
    .cal-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; }
    .cal-title{ font-weight:700; }
    .cal-nav{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
    .cal-nav .navbtn,.cal-nav .ghost.small{ padding:6px 10px; border-radius:10px; border:1px solid var(--separator); background:transparent; cursor:pointer; color:var(--tg-theme-text-color); }
    .cal-nav .navbtn:hover,.cal-nav .ghost.small:hover{ border-color:var(--app-accent); color:var(--app-accent); }
    .cal-week{ display:grid; grid-template-columns:repeat(7,1fr); gap:4px; color:var(--tg-theme-hint-color); font-size:12px; }
    .cal-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }
    .cal-day{ position:relative; padding:10px 0; text-align:center; border-radius:10px; cursor:pointer; user-select:none; background:var(--tg-theme-bg-color); border:1px solid transparent; }
    .cal-day.disabled{ opacity:.4; cursor:default; }
    .cal-day.today{ outline:1px dashed var(--app-accent); }
    .cal-day.selected{ border-color:var(--app-accent); box-shadow:0 0 0 1px var(--app-accent) inset; }
    .cal-num{ font-weight:600; }
    .cal-hint{ position:absolute; inset:2px; border-radius:8px; pointer-events:none; opacity:0; }
    .cal-day.has-1{ border-color:var(--app-accent); }
    .cal-day.has-3 .cal-hint{ background:var(--app-accent); opacity:.12; }
    .cal-day.has-6 .cal-hint{ background:var(--app-accent); opacity:.22; }
    .cal-day.has-10 .cal-hint{ background:var(--app-accent); opacity:.32; }

    .day-chip{ display:flex; align-items:center; gap:8px; margin:6px 0 2px; color:var(--tg-theme-hint-color); }
    .day-chip .small{ padding:6px 10px; border-radius:10px; }

    .cases-list{ display:grid; gap:8px; margin-top:8px; }
    .case-card{ border:1px solid var(--separator); background:var(--tg-theme-secondary-bg-color);
      border-radius:16px; padding:12px; display:grid; gap:6px; }
    .case-head{ display:flex; justify-content:space-between; align-items:baseline; gap:8px; }
    .case-number{ font-weight:700; }
    .badge{ font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--separator); color:var(--tg-theme-hint-color); }
    .badge.active{ color:var(--app-accent); border-color:var(--app-accent); }
    .case-row{ display:flex; gap:10px; flex-wrap:wrap; color:var(--tg-theme-hint-color); font-size:14px; }
    .case-actions{ display:flex; gap:8px; margin-top:6px; }
    .pill.today-pill{ margin-left:8px; padding:2px 8px; border-radius:999px; border:1px solid var(--app-accent); color:var(--app-accent); font-size:12px; }

    .cases-empty{ text-align:center; padding:20px 8px; color:var(--tg-theme-hint-color); }
    .cases-empty .emoji{ font-size:36px; margin-bottom:8px; }
    .cases-empty .title{ font-weight:700; color:var(--tg-theme-text-color); }
    .list-spacer{ height:16px; }

    @media (max-width:520px){ .cases-form .grid{ grid-template-columns:1fr; } .suggest{ max-height:50vh; } }
  </style>

  <script type="text/plain" id="hearings-inline-js">
  (function(){
    const DAY = 24*60*60*1000;

    function setExpanded(btn, wrap, open){ btn?.setAttribute('aria-expanded', String(open)); wrap?.setAttribute('aria-hidden', String(!open)); }
    const nowTs = () => Date.now();
    function toTs(dateStr, timeStr){ if(!dateStr) return NaN; const t = timeStr && /^\d{2}:\d{2}$/.test(timeStr) ? timeStr : '00:00'; const ts=Date.parse(dateStr+'T'+t+':00'); return isNaN(ts)?NaN:ts; }
    function fmtDate(d){ try{ return new Date(d).toLocaleDateString('ru-RU'); }catch(_){ return '‚Äî'; } }
    function fmtMonthTitle(date){ return date.toLocaleDateString('ru-RU',{month:'long',year:'numeric'}); }
    function fmtDayLabel(s){ try{ const d=new Date(s); return d.toLocaleDateString('ru-RU',{day:'2-digit',month:'long',year:'numeric'});}catch(_){return s;} }
    function isSameDay(dateStr){ try{ const d=new Date(dateStr), n=new Date(); return d.getFullYear()===n.getFullYear()&&d.getMonth()===n.getMonth()&&d.getDate()===n.getDate(); }catch(_){return false;} }
    function pad2(n){return n<10?'0'+n:''+n;}
    function monthInfo(date){ const y=date.getFullYear(), m=date.getMonth(); const first=new Date(y,m,1), last=new Date(y,m+1,0); const dow=(first.getDay()+6)%7; return {y,m,daysInMonth:last.getDate(),startOffset:dow}; }
    function ymDate(y,m,d){ return `${y}-${pad2(m+1)}-${pad2(d)}`; }

    // –∏–Ω–¥–µ–∫—Å –¥–µ–ª
    function loadCasesIndex(){
      try{
        const raw=localStorage.getItem('tl_cases_v1'); if(!raw) return [];
        const arr=JSON.parse(raw)||[]; const map=new Map();
        arr.forEach(c=>{ if(!c||!c.number) return; const key=String(c.number).trim(); if(!map.has(key)) map.set(key,{number:key, debtor:c.debtor||'', court:c.court||''}); });
        return Array.from(map.values());
      }catch(_){ return []; }
    }

    // –ø–∞—Ä—Å–µ—Ä –∫–æ–º–±–æ—Å—Ç—Ä–æ–∫–∏
    function parseComboToFields(text){
      const s=(text||'').trim();
      const caseRe = /[A–ê]\s*\d{1,3}[-‚Äì]\d{3,7}\/\d{2,4}/i;
      const m = s.match(caseRe);
      const number = m ? m[0].replace(/\s+/g,'').toUpperCase().replace('A','–ê') : '';
      let debtor = s;
      if (m) debtor = (s.slice(0, m.index) + s.slice(m.index + m[0].length)).replace(/[‚Äì‚Äî-]/g,' ').trim();
      return { number, debtor };
    }

    function buildCalendarHTML(state, counts){
      const ref=new Date(state.calendar.year, state.calendar.month, 1);
      const y=ref.getFullYear(), m=ref.getMonth();
      const first=new Date(y,m,1), last=new Date(y,m+1,0);
      const daysInMonth=last.getDate(), startOffset=(first.getDay()+6)%7;
      const monthName=fmtMonthTitle(ref);
      const weekNames=['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
      const totalCells=Math.ceil((startOffset+daysInMonth)/7)*7;

      let head = `
        <div class="cal-head">
          <div class="cal-title">${monthName[0].toUpperCase()+monthName.slice(1)}</div>
          <div class="cal-nav">
            <button type="button" class="navbtn" data-cal-prev>‚Äπ</button>
            <button type="button" class="navbtn" data-cal-next>‚Ä∫</button>
            <button type="button" class="ghost small" data-cal-today>–°–µ–≥–æ–¥–Ω—è</button>
            <button type="button" class="ghost small" data-cal-jump="+1">+1–º</button>
            <button type="button" class="ghost small" data-cal-jump="+3">+3–º</button>
            <button type="button" class="ghost small" data-cal-jump="+6">+6–º</button>
          </div>
        </div>
      `;

      let cells='';
      for(let i=0;i<totalCells;i++){
        const dayNum=i-startOffset+1;
        if(dayNum<1||dayNum>daysInMonth){ cells+=`<div class="cal-day disabled" aria-hidden="true"></div>`; continue; }
        const dateStr=ymDate(y,m,dayNum);
        const cnt=counts[dateStr]||0;
        let cls='cal-day'; if(isSameDay(dateStr)) cls+=' today'; if(state.selectedDay===dateStr) cls+=' selected';
        if(cnt>=10) cls+=' has-10'; else if(cnt>=6) cls+=' has-6'; else if(cnt>=3) cls+=' has-3'; else if(cnt>=1) cls+=' has-1';
        cells+=`<button type="button" class="${cls}" data-date="${dateStr}" aria-label="${dayNum}. ${monthName}, –∑–∞—Å–µ–¥–∞–Ω–∏–π: ${cnt}"><div class="cal-hint"></div><div class="cal-num">${dayNum}</div></button>`;
      }

      return head + `<div class="cal-week">${weekNames.map(w=>`<div style="text-align:center;">${w}</div>`).join('')}</div>
                     <div class="cal-grid">${cells}</div>`;
    }

    window.HEARINGS = {
      LS_KEY: 'tl_hearings_v1',
      data: [],
      casesIndex: [],
      state: { query:'', filter:'all', selectedDay:null, calendar:{ year:(new Date()).getFullYear(), month:(new Date()).getMonth() } },
      editingId: null,

      refreshCasesIndex(){ this.casesIndex = loadCasesIndex(); },

      init(){
        try{ const raw=localStorage.getItem(this.LS_KEY); this.data=raw?JSON.parse(raw):[]; if(!Array.isArray(this.data)) this.data=[]; }catch(e){ this.data=[]; }
        this.refreshCasesIndex();
        this.autoArchiveStale();
        this.initComboSuggest();
        this.render();
      },

      save(){ localStorage.setItem(this.LS_KEY, JSON.stringify(this.data)); },

      setQuery(v){ this.state.query=(v||'').toLowerCase(); this.render(); },
      setFilter(f){
        this.state.filter=f;
        document.querySelectorAll('#hearings-page .chip').forEach(ch=>{
          ch.classList.toggle('active', ch.dataset.filter===f);
          ch.setAttribute('aria-selected', String(ch.dataset.filter===f));
        });
        this.render();
      },

      jumpMonths(delta){
        const d=new Date(this.state.calendar.year,this.state.calendar.month,1); d.setMonth(d.getMonth()+delta);
        this.state.calendar.year=d.getFullYear(); this.state.calendar.month=d.getMonth(); this.render();
      },
      gotoTodayMonth(){ const d=new Date(); this.state.calendar.year=d.getFullYear(); this.state.calendar.month=d.getMonth(); this.render(); },

      clearSelectedDay(){
        this.state.selectedDay = null;
        const chip  = document.getElementById('hearings-day-chip');
        const label = document.getElementById('hearings-day-label');
        if (label) label.textContent = '';
        if (chip)  chip.hidden = true;
        this.render();
      },

      toggleForm(force){
        const wrap=document.getElementById('hearings-form-wrap');
        const btn=document.getElementById('hearings-add-btn');
        const isOpen=wrap.classList.contains('open');
        const shouldOpen=(typeof force==='boolean')?force:!isOpen; if(shouldOpen===isOpen) return;
        wrap.style.overflow='hidden';
        if(shouldOpen){
          wrap.classList.add('open'); wrap.style.maxHeight=wrap.scrollHeight+'px'; setExpanded(btn,wrap,true);
          document.getElementById('h-combo').focus(); // –ø–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        } else {
          wrap.style.maxHeight=wrap.scrollHeight+'px'; requestAnimationFrame(()=>{ wrap.style.maxHeight='0px'; });
          setExpanded(btn,wrap,false);
          wrap.addEventListener('transitionend',()=>{ wrap.classList.remove('open'); HEARINGS.cancelEdit(); },{once:true});
        }
      },

      /* === –ö–û–ú–ë–û-–ü–û–î–°–ö–ê–ó–ö–ò (–Ω–æ–º–µ—Ä+–¥–æ–ª–∂–Ω–∏–∫) === */
      initComboSuggest(){
        const input = document.getElementById('h-combo');
        const box   = document.getElementById('h-combo-suggest');
        if(!input || !box) return;

        const openWith = (q)=>{ this.refreshCasesIndex(); this.buildComboSuggestions(box, q); };
        input.addEventListener('click', ()=>openWith(input.value));
        input.addEventListener('input', ()=>openWith(input.value));
        input.addEventListener('blur', ()=>setTimeout(()=>{ box.hidden=true; },120));

        box.addEventListener('mousedown', (e)=>{
          const item = e.target.closest('.suggest-item'); if(!item) return;
          const number = item.getAttribute('data-number')||'';
          const debtor = item.getAttribute('data-debtor')||'';
          const court  = item.getAttribute('data-court')||'';
          document.getElementById('h-case').value = number;
          document.getElementById('h-debtor').value = debtor;
          input.value = number + (debtor ? ' ‚Äî ' + debtor : '');
          const c = document.getElementById('h-court'); if(c && !c.value && court) c.value=court;
          box.hidden = true;
        });
      },
      buildComboSuggestions($box, query){
        const list=this.casesIndex||[]; const q=(query||'').toLowerCase().trim();
        let items=!q?list.slice(0,7):list.filter(c=> c.number.toLowerCase().includes(q) || (c.debtor||'').toLowerCase().includes(q) ).slice(0,7);
        if(!items.length){ $box.hidden=true; $box.innerHTML=''; return; }
        $box.innerHTML = items.map(c=>`
          <div class="suggest-item" role="option"
               data-number="${c.number}" data-debtor="${c.debtor||''}" data-court="${c.court||''}">
            <span><strong>${c.number}</strong></span>
            <span class="hint">${c.debtor||''}</span>
          </div>`).join('');
        $box.hidden=false;
      },

      // ---- CRUD ----
      edit(id){
        const i=this.data.find(x=>x.id===id); if(!i) return;
        this.editingId=id;
        document.getElementById('h-case').value   = i.caseNumber||'';
        document.getElementById('h-debtor').value = i.debtor||'';
        document.getElementById('h-combo').value  = (i.caseNumber||'') + (i.debtor?(' ‚Äî '+i.debtor):'');

        const dtEl=document.getElementById('h-datetime');
        if (dtEl) dtEl.value = (i.date?i.date:'') + 'T' + ((i.time||'').slice(0,5) || '00:00');

        document.getElementById('h-court').value  = i.court||'';
        document.getElementById('h-place').value  = i.place||'';
        document.getElementById('h-note').value   = i.note||'';
        document.getElementById('h-status').value = i.status||'active';
        document.getElementById('hearings-submit-btn').textContent='–û–±–Ω–æ–≤–∏—Ç—å';
        const wrap=document.getElementById('hearings-form-wrap'); if(!wrap.classList.contains('open')) this.toggleForm(true);
      },
      cancelEdit(){
        this.editingId=null;
        document.getElementById('hearings-submit-btn').textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        ['h-case','h-debtor','h-combo','h-datetime','h-court','h-place','h-note'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
        document.getElementById('h-status').value='active';
      },
      submit(ev){
        ev.preventDefault();
        // —Ä–∞—Å–ø–∞—Ä—Å–∏–º –∫–æ–º–±–æ—Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ –ø–æ–¥—Å–∫–∞–∑–∫—É –Ω–µ –≤—ã–±–∏—Ä–∞–ª–∏
        const combo = document.getElementById('h-combo').value;
        let number  = document.getElementById('h-case').value;
        let debtor  = document.getElementById('h-debtor').value;
        if(!number && combo){
          const parsed = parseComboToFields(combo);
          number = parsed.number;
          debtor = debtor || parsed.debtor;
          document.getElementById('h-case').value = number;
          document.getElementById('h-debtor').value = debtor;
        }

        const dtVal = document.getElementById('h-datetime').value;
        if(!number){ alert('–£–∫–∞–∂–∏ –Ω–æ–º–µ—Ä –¥–µ–ª–∞.'); return; }
        if(!dtVal){ alert('–£–∫–∞–∂–∏ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –∑–∞—Å–µ–¥–∞–Ω–∏—è.'); return; }
        const parts = dtVal.split('T');
        const date = parts[0] || '';
        const time = (parts[1] || '').slice(0,5);

        const court=document.getElementById('h-court').value.trim();
        const place=document.getElementById('h-place').value.trim();
        const note=document.getElementById('h-note').value.trim();
        const status=document.getElementById('h-status').value;

        if(this.editingId){
          const i=this.data.findIndex(x=>x.id===this.editingId);
          if(i!==-1) this.data[i]={...this.data[i], caseNumber:number, debtor, date, time, court, place, note, status, updatedAt:Date.now()};
        } else {
          this.data.push({ id:String(Date.now()), caseNumber:number, debtor, date, time, court, place, note,
            status: status==='archived'?'archived':'active', createdAt:Date.now(), updatedAt:Date.now() });
        }
        this.save();
        this.cancelEdit(); this.toggleForm(false); this.autoArchiveStale(); this.render();
      },
      toggleArchive(id){ const it=this.data.find(x=>x.id===id); if(!it) return; it.status=it.status==='active'?'archived':'active'; it.updatedAt=Date.now(); this.save(); this.render(); },
      remove(id){ if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—Å–µ–¥–∞–Ω–∏–µ?')) return; this.data=this.data.filter(x=>x.id!==id); this.save(); this.render(); },

      // –ê–≤—Ç–æ–∞—Ä—Ö–∏–≤ —á–µ—Ä–µ–∑ 3 –¥–Ω—è –ø–æ—Å–ª–µ –¥–∞—Ç—ã –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞
      autoArchiveStale(){
        const now=nowTs(); let dirty=false;
        this.data.forEach(i=>{
          if(i.status!=='active') return;
          const ts=toTs(i.date,i.time); if(isNaN(ts)) return;
          const threshold=ts + 3*DAY; const upd=i.updatedAt||i.createdAt||0;
          if(now>=threshold && upd<ts){ i.status='archived'; dirty=true; }
        });
        if(dirty) this.save();
      },

      // ---- –ö–∞–ª–µ–Ω–¥–∞—Ä—å ----
      buildCountsForCalendar(){
        const counts={}; const d=new Date(this.state.calendar.year,this.state.calendar.month,1);
        const y=d.getFullYear(), m=d.getMonth(); const last=new Date(y,m+1,0); const daysInMonth=last.getDate();
        for(let day=1; day<=daysInMonth; day++){ counts[ymDate(y,m,day)]=0; }
        this.data.forEach(i=>{ if(i.status==='archived'||!i.date) return; const ds=i.date; if(Object.hasOwn(counts, ds)) counts[ds]+=1; });
        return counts;
      },
      renderCalendar(){
        const cal=document.getElementById('hearings-calendar'); if(!cal) return;
        const counts=this.buildCountsForCalendar(); cal.innerHTML=buildCalendarHTML(this.state, counts);
        cal.querySelector('[data-cal-prev]')?.addEventListener('click',()=>this.jumpMonths(-1));
        cal.querySelector('[data-cal-next]')?.addEventListener('click',()=>this.jumpMonths(+1));
        cal.querySelector('[data-cal-today]')?.addEventListener('click',()=>this.gotoTodayMonth());
        cal.querySelectorAll('[data-cal-jump]').forEach(b=>b.addEventListener('click',()=>{ const n=parseInt((b.getAttribute('data-cal-jump')||'+1').replace('+',''),10); if(!isNaN(n)) this.jumpMonths(n); }));
        cal.querySelectorAll('.cal-day[data-date]').forEach(btn=>btn.addEventListener('click',()=>{
          const date=btn.getAttribute('data-date'); this.state.selectedDay=date;
          const chip=document.getElementById('hearings-day-chip'); const label=document.getElementById('hearings-day-label');
          if(chip && label){ label.textContent=fmtDayLabel(date); chip.hidden=false; }
          this.render();
        }));
      },

      isUpcoming(i){ const ts=toTs(i.date,i.time); return !isNaN(ts) && ts>=nowTs(); },

      render(){
        const list=document.getElementById('hearings-list'); const empty=document.getElementById('hearings-empty');
        let items=this.data.slice(); const q=this.state.query;

        if(q){
          items=items.filter(i =>
            (i.caseNumber||'').toLowerCase().includes(q) ||
            (i.debtor||'').toLowerCase().includes(q) ||
            (i.court||'').toLowerCase().includes(q) ||
            (i.place||'').toLowerCase().includes(q) ||
            (i.note||'').toLowerCase().includes(q) ||
            (i.date||'').includes(q) || (i.time||'').includes(q)
          );
        }
        if(this.state.selectedDay){ items=items.filter(i => (i.date||'')===this.state.selectedDay); }

        // ‚ùó –ê—Ä—Ö–∏–≤ —Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é + –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–µ—Å–µ—Ç—ã
        if (this.state.filter === 'archived') {
          items = items.filter(i => i.status === 'archived');
        } else if (this.state.filter === 'upcoming') {
          items = items.filter(i => i.status !== 'archived' && this.isUpcoming(i));
        } else if (this.state.filter === 'past') {
          items = items.filter(i => i.status !== 'archived' && !this.isUpcoming(i));
        } else {
          items = items.filter(i => i.status !== 'archived'); // 'all'
        }

        const now=nowTs();
        items.sort((a,b)=>{ const at=toTs(a.date,a.time), bt=toTs(b.date,b.time); const aF=!isNaN(at)&&at>=now, bF=!isNaN(bt)&&bt>=now;
          if(this.state.filter==='upcoming') return at - bt;
          if(this.state.filter==='past') return bt - at;
          if(aF!==bF) return aF?-1:1;
          return aF?(at-bt):(bt-at);
        });

        if(!items.length){ list.innerHTML=''; empty.hidden=false; this.renderCalendar();
          // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–∏–ø–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
          const chip=document.getElementById('hearings-day-chip'); if (chip) chip.hidden = !this.state.selectedDay;
          window.adjustBottomSpacer&&window.adjustBottomSpacer(); return;
        }
        empty.hidden=true;

        list.innerHTML=items.map(i=>{
          const ts=toTs(i.date,i.time); const upcoming=!isNaN(ts)&&ts>=now; const dt=`${fmtDate(i.date)} ${i.time?i.time:''}`.trim(); const today=isSameDay(i.date);
          return `
            <article class="case-card ${today?'today':''}" role="listitem" data-id="${i.id}">
              <div class="case-head">
                <div class="case-number">${i.caseNumber}${today?'<span class="pill today-pill">–°–µ–≥–æ–¥–Ω—è</span>':''}</div>
                <div class="badge ${i.status==='active'?'active':''}">${i.status==='active'?(upcoming?'–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ':'–ü—Ä–æ—à–µ–¥—à–∏–µ'):'–ê—Ä—Ö–∏–≤'}</div>
              </div>
              <div class="case-row">
                <span><strong>–î–∞—Ç–∞/–≤—Ä–µ–º—è:</strong> ${dt||'‚Äî'}</span>
                ${i.debtor?`<span><strong>–î–æ–ª–∂–Ω–∏–∫:</strong> ${i.debtor}</span>`:''}
                ${i.court?`<span><strong>–°—É–¥:</strong> ${i.court}</span>`:''}
                ${i.place?`<span><strong>–ó–∞–ª/–∞–¥—Ä–µ—Å:</strong> ${i.place}</span>`:''}
              </div>
              ${i.note?`<div class="case-row"><span><strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> ${i.note}</span></div>`:''}
              <div class="case-actions">
                <button class="ghost" onclick="HEARINGS && HEARINGS.toggleArchive('${i.id}')">${i.status==='active'?'–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å':'–í–µ—Ä–Ω—É—Ç—å –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ'}</button>
                <button class="ghost" onclick="HEARINGS && HEARINGS.edit('${i.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="ghost" onclick="HEARINGS && HEARINGS.remove('${i.id}')">–£–¥–∞–ª–∏—Ç—å</button>
              </div>
            </article>
          `;
        }).join('');

        this.renderCalendar();
        // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–∏–ø–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
        const chip=document.getElementById('hearings-day-chip'); if (chip) chip.hidden = !this.state.selectedDay;

        window.adjustBottomSpacer && window.adjustBottomSpacer();
      }
    };

    window.HEARINGS.init();
  })();
  </script>

  <img alt="" aria-hidden="true" style="display:none"
       src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
       onload='(function(){var s=document.getElementById("hearings-inline-js"); if(s){ new Function(s.textContent)(); }})();' />
</section>
