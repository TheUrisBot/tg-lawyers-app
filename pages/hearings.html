<section class="page hearings" id="hearings-page" aria-labelledby="hearings-title">
  <h1 id="hearings-title">–ó–∞—Å–µ–¥–∞–Ω–∏—è</h1>

  <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
  <div class="cases-toolbar" role="region" aria-label="–ü–æ–∏—Å–∫ –∏ –¥–µ–π—Å—Ç–≤–∏—è">
    <div class="cases-search">
      <input id="hearings-search-input" type="search" placeholder="–ù–æ–º–µ—Ä –¥–µ–ª–∞, –¥–æ–ª–∂–Ω–∏–∫, —Å—É–¥, –∑–∞–ª, –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ"
             aria-label="–ü–æ–∏—Å–∫ –ø–æ –∑–∞—Å–µ–¥–∞–Ω–∏—è–º" oninput="HEARINGS && HEARINGS.setQuery(this.value)" />
      <button class="ghost" aria-label="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫"
              onclick="HEARINGS && HEARINGS.setQuery(''); const i=document.getElementById('hearings-search-input'); i.value=''; i.focus();">‚úï</button>
    </div>
    <button class="primary" id="hearings-add-btn" aria-expanded="false" onclick="HEARINGS && HEARINGS.toggleForm()">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>

  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <div class="cases-filters" role="tablist" aria-label="–§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É">
    <button role="tab" class="chip active" data-filter="all" onclick="HEARINGS && HEARINGS.setFilter('all')">–í—Å–µ</button>
    <button role="tab" class="chip" data-filter="upcoming" onclick="HEARINGS && HEARINGS.setFilter('upcoming')">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ</button>
    <button role="tab" class="chip" data-filter="past" onclick="HEARINGS && HEARINGS.setFilter('past')">–ü—Ä–æ—à–µ–¥—à–∏–µ</button>
    <button role="tab" class="chip" data-filter="archived" onclick="HEARINGS && HEARINGS.setFilter('archived')">–ê—Ä—Ö–∏–≤</button>
  </div>

  <!-- –ö–ê–õ–ï–ù–î–ê–†–¨ -->
  <div id="hearings-calendar" class="cal" aria-label="–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞—Å–µ–¥–∞–Ω–∏–π (—Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü)"></div>

  <!-- –ü–ª–∞—à–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã -->
  <div id="hearings-day-chip" class="day-chip" hidden>
    <span id="hearings-day-label"></span>
    <button class="ghost small" onclick="HEARINGS && HEARINGS.clearSelectedDay()" aria-label="–°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É">–°–±—Ä–æ—Å–∏—Ç—å</button>
  </div>

  <!-- –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã–π –±–ª–æ–∫ —Ñ–æ—Ä–º—ã -->
  <div id="hearings-form-wrap" class="collapse" aria-hidden="true">
    <form id="hearings-form" class="cases-form" onsubmit="HEARINGS && HEARINGS.submit(event)">
      <div class="grid">
        <label class="has-suggest">
          <span>–ù–æ–º–µ—Ä –¥–µ–ª–∞ *</span>
          <input type="text" id="h-case" required placeholder="–ê40-12345/2025" autocomplete="off" />
          <div id="h-case-suggest" class="suggest" role="listbox" hidden></div>
        </label>
        <label>
          <span>–î–æ–ª–∂–Ω–∏–∫</span>
          <input type="text" id="h-debtor" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò. / –û–û–û ¬´–†–æ–≥–∞ –∏ –ö–æ–ø—ã—Ç–∞¬ª" />
        </label>
        <label>
          <span>–î–∞—Ç–∞ *</span>
          <input type="date" id="h-date" required />
        </label>
        <label>
          <span>–í—Ä–µ–º—è</span>
          <input type="time" id="h-time" />
        </label>
        <label>
          <span>–°—É–¥</span>
          <input type="text" id="h-court" placeholder="–ê–° –≥. –ú–æ—Å–∫–≤—ã" />
        </label>
        <label>
          <span>–ó–∞–ª / –ê–¥—Ä–µ—Å</span>
          <input type="text" id="h-place" placeholder="–ó–∞–ª 314 / —É–ª. –ü—Ä–∏–º–µ—Ä, 1" />
        </label>
        <label style="grid-column: 1 / -1;">
          <span>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</span>
          <textarea id="h-note" rows="2" placeholder="–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –∑–∞—Å–µ–¥–∞–Ω–∏—é"></textarea>
        </label>
        <label>
          <span>–°—Ç–∞—Ç—É—Å</span>
          <select id="h-status">
            <option value="active" selected>–ê–∫—Ç–∏–≤–Ω–æ–µ</option>
            <option value="archived">–ê—Ä—Ö–∏–≤</option>
          </select>
        </label>
      </div>
      <div class="form-actions">
        <button type="button" class="ghost" onclick="HEARINGS && HEARINGS.toggleForm(false)">–°–≤–µ—Ä–Ω—É—Ç—å</button>
        <button type="submit" class="primary" id="hearings-submit-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>

  <!-- –°–ø–∏—Å–æ–∫ –∑–∞—Å–µ–¥–∞–Ω–∏–π -->
  <div id="hearings-list" class="cases-list" role="list"></div>
  <div class="list-spacer" id="hearings-spacer" aria-hidden="true"></div>

  <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
  <div id="hearings-empty" class="cases-empty" hidden>
    <div class="emoji" aria-hidden="true">üóìÔ∏è</div>
    <div class="title">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞—Å–µ–¥–∞–Ω–∏–π</div>
    <div class="hint">–î–æ–±–∞–≤—å –ø–µ—Ä–≤–æ–µ –∑–∞—Å–µ–¥–∞–Ω–∏–µ: –Ω–æ–º–µ—Ä –¥–µ–ª–∞, –¥–∞—Ç–∞ –∏, –ø–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –≤—Ä–µ–º—è.</div>
    <button class="primary" onclick="HEARINGS && HEARINGS.toggleForm(true)">–î–æ–±–∞–≤–∏—Ç—å –∑–∞—Å–µ–¥–∞–Ω–∏–µ</button>
  </div>

  <!-- –°—Ç–∏–ª–∏ -->
  <style>
    .cases-toolbar { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
    .cases-search { display: grid; grid-template-columns: 1fr auto; gap: 6px; }
    .cases-search input {
      width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--separator);
      background: var(--tg-theme-secondary-bg-color); color: var(--tg-theme-text-color); outline: none;
    }
    .cases-search input:focus { border-color: var(--app-accent); }
    .cases-filters { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip { border: 1px solid var(--separator); background: transparent; color: var(--tg-theme-text-color);
      padding: 6px 10px; border-radius: 999px; cursor: pointer; }
    .chip.active { border-color: var(--app-accent); color: var(--app-accent); font-weight: 600; }

    /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */
    .cal { border: 1px solid var(--separator); border-radius: 16px; background: var(--tg-theme-secondary-bg-color); padding: 10px; display: grid; gap: 8px; }
    .cal-head { display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap; }
    .cal-title { font-weight: 700; }
    .cal-nav { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    .cal-nav .navbtn,
    .cal-nav .ghost.small {
      padding: 6px 10px; border-radius: 10px; border: 1px solid var(--separator); background: transparent; cursor: pointer;
      color: var(--tg-theme-text-color);
    }
    .cal-nav .navbtn:hover,
    .cal-nav .ghost.small:hover { border-color: var(--app-accent); color: var(--app-accent); }

    .cal-week { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; color: var(--tg-theme-hint-color); font-size: 12px; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .cal-day {
      position: relative; padding: 10px 0; text-align: center; border-radius: 10px; cursor: pointer;
      user-select: none; background: var(--tg-theme-bg-color); border: 1px solid transparent;
    }
    .cal-day.disabled { opacity: .4; cursor: default; }
    .cal-day.today { outline: 1px dashed var(--app-accent); }
    .cal-day.selected { border-color: var(--app-accent); box-shadow: 0 0 0 1px var(--app-accent) inset; }
    .cal-num { font-weight: 600; }
    .cal-hint { position: absolute; inset: 2px; border-radius: 8px; pointer-events: none; opacity: 0; }
    /* –£—Ä–æ–≤–Ω–∏ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –¥–µ–ª */
    .cal-day.has-1 { border-color: var(--app-accent); }
    .cal-day.has-3 .cal-hint { background: var(--app-accent); opacity: .12; }
    .cal-day.has-6 .cal-hint { background: var(--app-accent); opacity: .22; }
    .cal-day.has-10 .cal-hint{ background: var(--app-accent); opacity: .32; }

    .day-chip { display: flex; align-items: center; gap: 8px; margin: 6px 0 2px; color: var(--tg-theme-hint-color); }
    .day-chip .small { padding: 6px 10px; border-radius: 10px; }

    /* –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–∞—è –æ–±–ª–∞—Å—Ç—å –∏ –ø—Ä–æ—á–µ–µ ‚Äî –∫–∞–∫ —Ä–∞–Ω—å—à–µ */
    .collapse { max-height: 0; overflow: hidden; opacity: 0; transition: max-height 240ms ease, opacity 240ms ease; }
    .collapse.open { opacity: 1; }

    .cases-form {
      border: 1px solid var(--separator); background: var(--tg-theme-secondary-bg-color);
      border-radius: 16px; padding: 12px; display: grid; gap: 12px;
    }
    .cases-form .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .cases-form label { display: grid; gap: 6px; font-size: 12px; color: var(--tg-theme-hint-color); }
    .cases-form input, .cases-form select, .cases-form textarea {
      padding: 10px 12px; border-radius: 12px; border: 1px solid var(--separator);
      background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); outline: none; resize: vertical;
    }
    .cases-form input:focus, .cases-form select:focus, .cases-form textarea:focus { border-color: var(--app-accent); }
    .form-actions { display: flex; gap: 8px; justify-content: flex-end; }
    .primary, .ghost {
      appearance: none; border: 1px solid transparent; padding: 10px 12px; border-radius: 12px; cursor: pointer;
      background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color);
    }
    .ghost { background: transparent; border-color: var(--separator); color: var(--tg-theme-text-color); }

    .cases-list { display: grid; gap: 8px; }
    .case-card {
      border: 1px solid var(--separator); background: var(--tg-theme-secondary-bg-color);
      border-radius: 16px; padding: 12px; display: grid; gap: 6px; position: relative;
    }
    .case-head { display: flex; justify-content: space-between; align-items: baseline; gap: 8px; }
    .case-number { font-weight: 700; }
    .badge { font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid var(--separator); color: var(--tg-theme-hint-color); }
    .badge.active { color: var(--app-accent); border-color: var(--app-accent); }
    .case-row { display: flex; gap: 10px; flex-wrap: wrap; color: var(--tg-theme-hint-color); font-size: 14px; }
    .case-actions { display: flex; gap: 8px; margin-top: 6px; }

    .has-suggest { position: relative; }
    .suggest {
      position: absolute; top: 100%; left: 0; right: 0; z-index: 10;
      background: var(--tg-theme-bg-color); border: 1px solid var(--separator);
      border-radius: 12px; margin-top: 6px; max-height: 220px; overflow: auto;
      box-shadow: 0 6px 24px rgba(0,0,0,0.25);
    }
    .suggest-item { padding: 10px 12px; cursor: pointer; display: flex; justify-content: space-between; gap: 12px; }
    .suggest-item:hover, .suggest-item[aria-selected="true"] { background: var(--tg-theme-secondary-bg-color); }
    .suggest-item .hint { color: var(--tg-theme-hint-color); font-size: 12px; }

    @media (max-width: 520px) {
      .cases-form .grid { grid-template-columns: 1fr; }
      .suggest { max-height: 50vh; }
    }
  </style>

  <!-- –õ–æ–≥–∏–∫–∞ (–∏–Ω–µ—Ä—Ç–Ω—ã–π —Å–∫—Ä–∏–ø—Ç) -->
  <script type="text/plain" id="hearings-inline-js">
  (function () {
    const DAY = 24*60*60*1000;

    function setExpanded(btn, wrap, open) {
      btn?.setAttribute('aria-expanded', String(open));
      wrap?.setAttribute('aria-hidden', String(!open));
    }
    const nowTs = () => Date.now();
    function toTs(dateStr, timeStr) {
      if (!dateStr) return NaN;
      const t = timeStr && /^\d{2}:\d{2}$/.test(timeStr) ? timeStr : '00:00';
      const iso = dateStr + 'T' + t + ':00';
      const ts = Date.parse(iso);
      return isNaN(ts) ? NaN : ts;
    }
    function fmtDate(dateStr) {
      if (!dateStr) return '‚Äî';
      try { return new Date(dateStr).toLocaleDateString('ru-RU'); } catch (_) { return '‚Äî'; }
    }
    function fmtMonthTitle(date) {
      return date.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
    }
    function fmtDayLabel(yyyy_mm_dd) {
      try {
        const d = new Date(yyyy_mm_dd);
        return d.toLocaleDateString('ru-RU', { day: '2-digit', month: 'long', year: 'numeric' });
      } catch(_) { return yyyy_mm_dd; }
    }
    function isSameDay(dateStr) {
      if (!dateStr) return false;
      try {
        const d = new Date(dateStr);
        const n = new Date();
        return d.getFullYear()===n.getFullYear() && d.getMonth()===n.getMonth() && d.getDate()===n.getDate();
      } catch (_) { return false; }
    }

    // –î–µ–ª–∞ –∏–∑ cases (–¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫)
    function loadCasesIndex() {
      try {
        const raw = localStorage.getItem('tl_cases_v1');
        if (!raw) return [];
        const arr = JSON.parse(raw) || [];
        const map = new Map();
        arr.forEach(c => {
          if (!c || !c.number) return;
          const key = String(c.number).trim();
          if (!map.has(key)) map.set(key, { number: key, debtor: c.debtor || '', court: c.court || '' });
        });
        return Array.from(map.values());
      } catch (_) { return []; }
    }

    // ===== –ö–ê–õ–ï–ù–î–ê–†–¨ =====
    function monthInfo(date) {
      const y = date.getFullYear();
      const m = date.getMonth(); // 0..11
      const first = new Date(y, m, 1);
      const last  = new Date(y, m + 1, 0);
      const daysInMonth = last.getDate();
      const dow = (first.getDay() + 6) % 7; // 0=–ø–Ω..6=–≤—Å
      return { y, m, daysInMonth, startOffset: dow };
    }
    function pad2(n){ return n < 10 ? '0'+n : ''+n; }
    function ymDate(y,m,d){ return `${y}-${pad2(m+1)}-${pad2(d)}`; }
    function shiftMonth(y, m, delta) {
      const d = new Date(y, m, 1);
      d.setMonth(d.getMonth() + delta);
      return { year: d.getFullYear(), month: d.getMonth() };
    }

    function buildCalendarHTML(state, counts) {
      const ref = new Date(state.calendar.year, state.calendar.month, 1);
      const { y, m, daysInMonth, startOffset } = monthInfo(ref);
      const monthName = fmtMonthTitle(ref);
      const weekNames = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
      const totalCells = Math.ceil((startOffset + daysInMonth) / 7) * 7;

      // –∑–∞–≥–æ–ª–æ–≤–æ–∫ + –Ω–∞–≤–∏–≥–∞—Ü–∏—è
      let head = `
        <div class="cal-head">
          <div class="cal-title">${monthName[0].toUpperCase()+monthName.slice(1)}</div>
          <div class="cal-nav">
            <button type="button" class="navbtn" data-cal-prev aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü">‚Äπ</button>
            <button type="button" class="navbtn" data-cal-next aria-label="–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü">‚Ä∫</button>
            <button type="button" class="ghost small" data-cal-today>–°–µ–≥–æ–¥–Ω—è</button>
            <button type="button" class="ghost small" data-cal-jump="+1">+1–º</button>
            <button type="button" class="ghost small" data-cal-jump="+3">+3–º</button>
            <button type="button" class="ghost small" data-cal-jump="+6">+6–º</button>
          </div>
        </div>
      `;

      let cells = '';
      for (let i=0; i<totalCells; i++) {
        const dayNum = i - startOffset + 1;
        if (dayNum < 1 || dayNum > daysInMonth) {
          cells += `<div class="cal-day disabled" aria-hidden="true"></div>`;
          continue;
        }
        const dateStr = ymDate(y, m, dayNum);
        const cnt = counts[dateStr] || 0;
        let cls = 'cal-day';
        if (isSameDay(dateStr)) cls += ' today';
        if (state.selectedDay === dateStr) cls += ' selected';

        // —É—Ä–æ–≤–Ω–∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
        if (cnt >= 10) cls += ' has-10';
        else if (cnt >= 6) cls += ' has-6';
        else if (cnt >= 3) cls += ' has-3';
        else if (cnt >= 1) cls += ' has-1';

        cells += `
          <button type="button" class="${cls}" data-date="${dateStr}" aria-label="${dayNum}. ${monthName}, –∑–∞—Å–µ–¥–∞–Ω–∏–π: ${cnt}">
            <div class="cal-hint"></div>
            <div class="cal-num">${dayNum}</div>
          </button>
        `;
      }

      return head + `
        <div class="cal-week">${weekNames.map(w => `<div style="text-align:center;">${w}</div>`).join('')}</div>
        <div class="cal-grid">${cells}</div>
      `;
    }

    // ===== –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—ä–µ–∫—Ç HEARINGS =====
    window.HEARINGS = {
      LS_KEY: 'tl_hearings_v1',
      data: [],
      state: {
        query: '',
        filter: 'all',
        selectedDay: null,
        calendar: { year: (new Date()).getFullYear(), month: (new Date()).getMonth() }
      },
      editingId: null,
      casesIndex: [],

      init() {
        this.casesIndex = loadCasesIndex();

        try {
          const raw = localStorage.getItem(this.LS_KEY);
          this.data = raw ? JSON.parse(raw) : [];
        } catch(e) { this.data = []; }

        if (!this.data.length) {
          this.data = [
            { id: String(Date.now()-3), caseNumber: '–ê40-12345/2025', debtor: '–û–û–û ¬´–°–µ–≤–µ—Ä–¢–æ—Ä–≥¬ª', date: '2025-09-05', time: '10:00', court: '–ê–° –≥. –ú–æ—Å–∫–≤—ã', place: '–ó–∞–ª 2', note: '–ü–µ—Ä–≤–æ–µ –∑–∞—Å–µ–¥–∞–Ω–∏–µ', status: 'active', createdAt: Date.now()-30000, updatedAt: Date.now()-30000 },
            { id: String(Date.now()-2), caseNumber: '–ê56-9876/2024',  debtor: '–ò–≤–∞–Ω–æ–≤ –ò.–ò.',      date: '2025-08-20', time: '14:30', court: '–ê–° –°–ü–±',       place: '–ó–∞–ª 5', note: '',                 status: 'active', createdAt: Date.now()-20000, updatedAt: Date.now()-20000 },
            { id: String(Date.now()-1), caseNumber: '–ê40-22222/2023', debtor: '–û–û–û ¬´–†–æ–º–∞—à–∫–∞¬ª',    date: '2024-12-10', time: '11:00', court: '–ê–° –≥. –ú–æ—Å–∫–≤—ã', place: '',     note: '–í –∞—Ä—Ö–∏–≤–µ',         status: 'archived', createdAt: Date.now()-10000, updatedAt: Date.now()-10000 }
          ];
          this.save();
        }

        this.autoArchiveStale();
        this.initCaseSuggest();
        this.render(); // –≤ —Ç–æ–º —á–∏—Å–ª–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—å
      },

      save() { localStorage.setItem(this.LS_KEY, JSON.stringify(this.data)); },
      setQuery(v) { this.state.query = (v || '').toLowerCase(); this.render(); },

      setFilter(f) {
        this.state.filter = f;
        document.querySelectorAll('#hearings-page .chip').forEach(ch => {
          ch.classList.toggle('active', ch.dataset.filter === f);
          ch.setAttribute('aria-selected', String(ch.dataset.filter === f));
        });
        this.render();
      },

      // –ö–∞–ª–µ–Ω–¥–∞—Ä—å: —Å–º–µ–Ω–∞ –º–µ—Å—è—Ü–∞
      gotoMonth(year, month) {
        this.state.calendar.year = year;
        this.state.calendar.month = month; // 0..11
        this.render();
      },
      jumpMonths(delta) {
        const { year, month } = this.state.calendar;
        const next = shiftMonth(year, month, delta);
        this.gotoMonth(next.year, next.month);
      },
      gotoTodayMonth() {
        const d = new Date();
        this.gotoMonth(d.getFullYear(), d.getMonth());
      },

      // –°–±—Ä–æ—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –¥–∞—Ç—ã
      clearSelectedDay() {
        this.state.selectedDay = null;
        const chip = document.getElementById('hearings-day-chip');
        if (chip) chip.hidden = true;
        this.render();
      },

      // –ü–ª–∞–≤–Ω–æ–µ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ
      toggleForm(force) {
        const wrap = document.getElementById('hearings-form-wrap');
        const btn  = document.getElementById('hearings-add-btn');
        const isOpen = wrap.classList.contains('open');
        const shouldOpen = (typeof force === 'boolean') ? force : !isOpen;
        if (shouldOpen === isOpen) return;

        wrap.style.overflow = 'hidden';
        if (shouldOpen) {
          wrap.classList.add('open');
          wrap.style.maxHeight = wrap.scrollHeight + 'px';
          setExpanded(btn, wrap, true);
          document.getElementById('h-case').focus();
        } else {
          wrap.style.maxHeight = wrap.scrollHeight + 'px';
          requestAnimationFrame(() => { wrap.style.maxHeight = '0px'; });
          setExpanded(btn, wrap, false);
          wrap.addEventListener('transitionend', () => {
            wrap.classList.remove('open');
            HEARINGS.cancelEdit();
          }, { once: true });
        }
      },

      // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –Ω–æ–º–µ—Ä—É –¥–µ–ª–∞
      initCaseSuggest() {
        const input = document.getElementById('h-case');
        const box   = document.getElementById('h-case-suggest');
        if (!input || !box) return;

        const update = () => this.buildSuggestions(box, input.value);
        input.addEventListener('input', update);
        input.addEventListener('focus', update);
        input.addEventListener('blur', () => setTimeout(() => { box.hidden = true; }, 120));

        box.addEventListener('mousedown', (e) => {
          const item = e.target.closest('.suggest-item');
          if (!item) return;
          const number = item.getAttribute('data-number') || '';
          const debtor = item.getAttribute('data-debtor') || '';
          const court  = item.getAttribute('data-court') || '';
          input.value = number;
          const d = document.getElementById('h-debtor');
          const c = document.getElementById('h-court');
          if (d && !d.value && debtor) d.value = debtor;
          if (c && !c.value && court)  c.value  = court;
          box.hidden = true;
        });
      },

      buildSuggestions($box, query) {
        const casesIndex = this.casesIndex || [];
        const q = (query || '').toLowerCase().trim();
        let items = [];
        if (!q) items = casesIndex.slice(0, 7);
        else items = casesIndex.filter(c => c.number.toLowerCase().includes(q)).slice(0, 7);

        if (!items.length) { $box.hidden = true; $box.innerHTML=''; return; }
        $box.innerHTML = items.map(c => `
          <div class="suggest-item" role="option" data-number="${c.number}" data-debtor="${c.debtor}" data-court="${c.court}">
            <span>${c.number}</span>
            <span class="hint">${c.debtor || ''}</span>
          </div>
        `).join('');
        $box.hidden = false;
      },

      // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
      edit(id) {
        const item = this.data.find(x => x.id === id);
        if (!item) return;
        this.editingId = id;

        document.getElementById('h-case').value  = item.caseNumber || '';
        document.getElementById('h-debtor').value= item.debtor || '';
        document.getElementById('h-date').value  = item.date || '';
        document.getElementById('h-time').value  = item.time || '';
        document.getElementById('h-court').value = item.court || '';
        document.getElementById('h-place').value = item.place || '';
        document.getElementById('h-note').value  = item.note || '';
        document.getElementById('h-status').value= item.status || 'active';
        document.getElementById('hearings-submit-btn').textContent = '–û–±–Ω–æ–≤–∏—Ç—å';

        const wrap = document.getElementById('hearings-form-wrap');
        if (!wrap.classList.contains('open')) this.toggleForm(true);
        else document.getElementById('h-case').focus();
      },

      cancelEdit() {
        this.editingId = null;
        document.getElementById('hearings-submit-btn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        this.clearForm();
      },

      submit(ev) {
        ev && ev.preventDefault();
        const caseNumber = document.getElementById('h-case').value.trim();
        const debtor     = document.getElementById('h-debtor').value.trim();
        const date       = document.getElementById('h-date').value;
        const time       = document.getElementById('h-time').value;
        const court      = document.getElementById('h-court').value.trim();
        const place      = document.getElementById('h-place').value.trim();
        const note       = document.getElementById('h-note').value.trim();
        const status     = document.getElementById('h-status').value;

        if (!caseNumber || !date) { alert('–ó–∞–ø–æ–ª–Ω–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –ù–æ–º–µ—Ä –¥–µ–ª–∞ –∏ –î–∞—Ç–∞.'); return; }

        if (this.editingId) {
          const idx = this.data.findIndex(x => x.id === this.editingId);
          if (idx !== -1) {
            const prev = this.data[idx];
            this.data[idx] = { ...prev, caseNumber, debtor, date, time, court, place, note, status, updatedAt: Date.now() };
          }
        } else {
          this.data.push({
            id: String(Date.now()),
            caseNumber, debtor, date, time, court, place, note,
            status: status === 'archived' ? 'archived' : 'active',
            createdAt: Date.now(),
            updatedAt: Date.now()
          });
        }

        this.save();
        this.cancelEdit();
        this.toggleForm(false);
        this.autoArchiveStale(); // –Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ—à–ª—ã—Ö –¥–∞—Ç
        this.render();
      },

      clearForm() {
        ['h-case','h-debtor','h-date','h-time','h-court','h-place','h-note'].forEach(id => {
          const el = document.getElementById(id); if (el) el.value = '';
        });
        document.getElementById('h-status').value = 'active';
      },

      toggleArchive(id) {
        const item = this.data.find(x => x.id === id); if (!item) return;
        item.status = item.status === 'active' ? 'archived' : 'active';
        item.updatedAt = Date.now();
        this.save(); this.render();
      },

      remove(id) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—Å–µ–¥–∞–Ω–∏–µ? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) return;
        this.data = this.data.filter(x => x.id !== id);
        this.save(); this.render();
      },

      // –ê–≤—Ç–æ–∞—Ä—Ö–∏–≤: >3 –¥–Ω–µ–π –ø–æ—Å–ª–µ –¥–∞—Ç—ã –∑–∞—Å–µ–¥–∞–Ω–∏—è –∏ –∑–∞–ø–∏—Å—å –Ω–µ –º–µ–Ω—è–ª–∞—Å—å –ø–æ—Å–ª–µ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞—Å–µ–¥–∞–Ω–∏—è
      autoArchiveStale() {
        const now = nowTs();
        let changed = false;
        this.data.forEach(i => {
          if (i.status !== 'active') return;
          const ts = toTs(i.date, i.time);
          if (isNaN(ts)) return;
          const threshold = ts + 3*DAY;
          const upd = i.updatedAt || i.createdAt || 0;
          if (now >= threshold && upd < ts) {
            i.status = 'archived';
            changed = true;
          }
        });
        if (changed) this.save();
      },

      isUpcoming(item) {
        const ts = toTs(item.date, item.time);
        return !isNaN(ts) && ts >= nowTs();
      },

      // –ü–æ–¥—Å—á—ë—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞—Å–µ–¥–∞–Ω–∏–π –Ω–∞ –∫–∞–∂–¥—É—é –¥–∞—Ç—É (–¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è)
      buildCountsForCalendar() {
        const counts = {};
        const ref = new Date(this.state.calendar.year, this.state.calendar.month, 1);
        const { y, m, daysInMonth } = monthInfo(ref);

        for (let d=1; d<=daysInMonth; d++) {
          counts[ymDate(y,m,d)] = 0;
        }
        this.data.forEach(i => {
          if (i.status === 'archived') return; // –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–µ —Å—á–∏—Ç–∞–µ–º –∞—Ä—Ö–∏–≤
          if (!i.date) return;
          const dstr = i.date;
          if (counts.hasOwnProperty(dstr)) counts[dstr] += 1;
        });
        return counts;
      },

      // –†–µ–Ω–¥–µ—Ä –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
      renderCalendar() {
        const cal = document.getElementById('hearings-calendar');
        if (!cal) return;
        const counts = this.buildCountsForCalendar();
        cal.innerHTML = buildCalendarHTML(this.state, counts);

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ—Å—è—Ü–∞–º–∏
        const prev = cal.querySelector('[data-cal-prev]');
        const next = cal.querySelector('[data-cal-next]');
        const today= cal.querySelector('[data-cal-today]');
        prev && prev.addEventListener('click', () => this.jumpMonths(-1));
        next && next.addEventListener('click', () => this.jumpMonths(+1));
        today && today.addEventListener('click', () => this.gotoTodayMonth());

        cal.querySelectorAll('[data-cal-jump]').forEach(btn => {
          btn.addEventListener('click', () => {
            const val = btn.getAttribute('data-cal-jump') || '+1';
            const n = parseInt(val.replace('+',''), 10);
            if (!isNaN(n)) this.jumpMonths(n);
          });
        });

        // –ö–ª–∏–∫–∏ –ø–æ –¥–Ω—è–º
        cal.querySelectorAll('.cal-day[data-date]').forEach(btn => {
          btn.addEventListener('click', () => {
            const date = btn.getAttribute('data-date');
            this.state.selectedDay = date;
            const chip = document.getElementById('hearings-day-chip');
            const label = document.getElementById('hearings-day-label');
            if (chip && label) {
              label.textContent = fmtDayLabel(date);
              chip.hidden = false;
            }
            this.render(); // –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º —Å–ø–∏—Å–æ–∫ –∏ —Å–∞–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å (–≤—ã–¥–µ–ª–µ–Ω–∏–µ)
          });
        });
      },

      render() {
        const list = document.getElementById('hearings-list');
        const empty = document.getElementById('hearings-empty');

        let items = this.data.slice();
        const q = this.state.query;

        if (q) {
          items = items.filter(i =>
            i.caseNumber.toLowerCase().includes(q) ||
            (i.debtor || '').toLowerCase().includes(q) ||
            (i.court || '').toLowerCase().includes(q) ||
            (i.place || '').toLowerCase().includes(q) ||
            (i.note || '').toLowerCase().includes(q) ||
            (i.date || '').includes(q) || (i.time || '').includes(q)
          );
        }

        // –§–∏–ª—å—Ç—Ä –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç–µ (–µ—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –¥–µ–Ω—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ)
        if (this.state.selectedDay) {
          items = items.filter(i => (i.date || '') === this.state.selectedDay);
        }

        // –ß–∏–ø-—Ñ–∏–ª—å—Ç—Ä—ã —Å—Ç–∞—Ç—É—Å–∞/–≤—Ä–µ–º–µ–Ω–∏
        if (this.state.filter === 'archived') {
          items = items.filter(i => i.status === 'archived');
        } else if (this.state.filter === 'upcoming') {
          items = items.filter(i => i.status !== 'archived' && this.isUpcoming(i));
        } else if (this.state.filter === 'past') {
          items = items.filter(i => i.status !== 'archived' && !this.isUpcoming(i));
        }

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        const now = nowTs();
        items.sort((a,b) => {
          const at = toTs(a.date, a.time), bt = toTs(b.date, b.time);
          const aFuture = !isNaN(at) && at >= now;
          const bFuture = !isNaN(bt) && bt >= now;
          if (this.state.filter === 'upcoming') return at - bt;
          if (this.state.filter === 'past')     return bt - at;
          if (aFuture !== bFuture) return aFuture ? -1 : 1;
          return aFuture ? (at - bt) : (bt - at);
        });

        if (!items.length) { list.innerHTML = ''; empty.hidden = false; this.renderCalendar(); window.adjustBottomSpacer && window.adjustBottomSpacer(); return; }
        empty.hidden = true;

        list.innerHTML = items.map(i => {
          const ts = toTs(i.date, i.time);
          const upcoming = !isNaN(ts) && ts >= now;
          const dt = `${fmtDate(i.date)} ${i.time ? i.time : ''}`.trim();
          const today = isSameDay(i.date);
          return `
            <article class="case-card ${today ? 'today' : ''}" role="listitem" data-id="${i.id}">
              <div class="case-head">
                <div class="case-number">${i.caseNumber}${today ? '<span class="pill today-pill">–°–µ–≥–æ–¥–Ω—è</span>' : ''}</div>
                <div class="badge ${i.status === 'active' ? 'active' : ''}">
                  ${i.status === 'active' ? (upcoming ? '–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ' : '–ü—Ä–æ—à–µ–¥—à–∏–µ') : '–ê—Ä—Ö–∏–≤'}
                </div>
              </div>
              <div class="case-row">
                <span><strong>–î–∞—Ç–∞/–≤—Ä–µ–º—è:</strong> ${dt || '‚Äî'}</span>
                ${i.debtor ? `<span><strong>–î–æ–ª–∂–Ω–∏–∫:</strong> ${i.debtor}</span>` : ''}
                ${i.court ? `<span><strong>–°—É–¥:</strong> ${i.court}</span>` : ''}
                ${i.place ? `<span><strong>–ó–∞–ª/–∞–¥—Ä–µ—Å:</strong> ${i.place}</span>` : ''}
              </div>
              ${i.note ? `<div class="case-row"><span><strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> ${i.note}</span></div>` : ''}
              <div class="case-actions">
                <button class="ghost" onclick="HEARINGS && HEARINGS.toggleArchive('${i.id}')">
                  ${i.status === 'active' ? '–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–í–µ—Ä–Ω—É—Ç—å –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ'}
                </button>
                <button class="ghost" onclick="HEARINGS && HEARINGS.edit('${i.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="ghost" onclick="HEARINGS && HEARINGS.remove('${i.id}')">–£–¥–∞–ª–∏—Ç—å</button>
              </div>
            </article>
          `;
        }).join('');

        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å (–≤—ã–¥–µ–ª–µ–Ω–∏—è –∏ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å)
        this.renderCalendar();

        // –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –Ω–∏–∂–Ω–∏–π —Å–ø–µ–π—Å–µ—Ä, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ –ø—Ä—è—Ç–∞–ª–∏—Å—å –ø–æ–¥ —Ç–∞–±–±–∞—Ä
        window.adjustBottomSpacer && window.adjustBottomSpacer();
      }
    };

    // –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.HEARINGS.init();
  })();
  </script>

  <!-- –¢—Ä–∏–≥–≥–µ—Ä –∑–∞–ø—É—Å–∫–∞ –ª–æ–≥–∏–∫–∏ –≤—ã—à–µ -->
  <img alt="" aria-hidden="true" style="display:none"
       src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
       onload='(function(){var s=document.getElementById("hearings-inline-js"); if(s){ new Function(s.textContent)(); }})();' />
</section>
