<section class="page" aria-labelledby="cases-title">
  <h1 id="cases-title">Дела</h1>

  <!-- Форма создания/редактирования дела -->
  <div class="card">
    <form id="case-form">
      <div style="display:grid; gap:8px;">
        <div style="display:grid; gap:4px;">
          <label for="caseNumber">Номер дела *</label>
          <input id="caseNumber" name="caseNumber" type="text" required placeholder="А40-12345/2025" />
        </div>

        <div style="display:grid; gap:4px;">
          <label for="debtorName">Должник (ФИО/Организация) *</label>
          <input id="debtorName" name="debtorName" type="text" required placeholder="Иванов Иван Иванович / ООО «Ромашка»" />
        </div>

        <div style="display:grid; gap:4px;">
          <label for="inn">ИНН</label>
          <input id="inn" name="inn" type="text" inputmode="numeric" pattern="\d{10}(\d{2})?" placeholder="10 или 12 цифр" />
        </div>

        <div style="display:grid; gap:4px;">
          <label for="court">Суд</label>
          <input id="court" name="court" type="text" placeholder="АС г. Москвы" />
        </div>

        <div style="display:grid; gap:4px;">
          <label for="status">Статус</label>
          <select id="status" name="status">
            <option value="">—</option>
            <option value="monitoring">Мониторинг</option>
            <option value="filed">Заявление подано</option>
            <option value="observ">Наблюдение</option>
            <option value="realiz">Реализация имущества</option>
            <option value="completed">Завершено</option>
          </select>
        </div>

        <div style="display:grid; gap:4px;">
          <label for="note">Примечание</label>
          <textarea id="note" name="note" rows="3" placeholder="Короткая заметка"></textarea>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:4px">
          <button type="submit" style="border:1px solid var(--divider); border-radius:10px; padding:8px 12px; background:transparent; color:var(--fg); cursor:pointer;">
            Сохранить дело
          </button>
          <button type="button" id="reset-form" style="border:1px solid var(--divider); border-radius:10px; padding:8px 12px; background:transparent; color:var(--fg); cursor:pointer;">
            Очистить форму
          </button>
        </div>

        <!-- скрытое поле для режима редактирования -->
        <input type="hidden" id="editingId" />
      </div>
    </form>
  </div>

  <!-- Поиск и список дел -->
  <div class="card">
    <div style="display:grid; gap:8px;">
      <input id="search" type="search" placeholder="Поиск по № делу / должнику / ИНН" />
      <div id="list-empty" style="display:none; color:var(--muted);">Пока нет дел. Добавьте первое выше.</div>
      <div id="cases-list" style="display:grid; gap:8px;"></div>
    </div>
  </div>
</section>

<script>
  (function () {
    const STORAGE_KEY = "cases:list:v1";

    const form = document.getElementById("case-form");
    const editingIdEl = document.getElementById("editingId");
    const listEl = document.getElementById("cases-list");
    const emptyEl = document.getElementById("list-empty");
    const searchEl = document.getElementById("search");

    const f = {
      caseNumber: document.getElementById("caseNumber"),
      debtorName: document.getElementById("debtorName"),
      inn: document.getElementById("inn"),
      court: document.getElementById("court"),
      status: document.getElementById("status"),
      note: document.getElementById("note"),
    };

    // --- Хранилище ---
    function loadAll() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch { return []; }
    }
    function saveAll(items) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }

    // --- Рендер списка ---
    function render(filter = "") {
      const q = filter.trim().toLowerCase();
      const items = loadAll();
      const filtered = q
        ? items.filter(it =>
            (it.caseNumber || "").toLowerCase().includes(q) ||
            (it.debtorName || "").toLowerCase().includes(q) ||
            (it.inn || "").toLowerCase().includes(q)
          )
        : items;

      listEl.innerHTML = "";
      emptyEl.style.display = filtered.length ? "none" : "block";

      filtered
        .sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0))
        .forEach(it => {
          const card = document.createElement("div");
          card.style.border = "1px solid var(--divider)";
          card.style.borderRadius = "12px";
          card.style.padding = "10px";
          card.style.background = "var(--surface)";
          card.style.display = "grid";
          card.style.gap = "6px";

          const title = document.createElement("div");
          title.style.display = "flex";
          title.style.justifyContent = "space-between";
          title.style.gap = "8px";
          title.style.alignItems = "baseline";
          title.innerHTML = `
            <div style="font-weight:600">${escapeHtml(it.caseNumber || "—")}</div>
            <div style="font-size:12px; color:var(--muted)">${it.status ? escapeHtml(statusLabel(it.status)) : ""}</div>
          `;

          const meta = document.createElement("div");
          meta.style.fontSize = "14px";
          meta.style.color = "var(--fg)";
          meta.innerHTML = `
            <div><strong>Должник:</strong> ${escapeHtml(it.debtorName || "—")}</div>
            <div><strong>ИНН:</strong> ${escapeHtml(it.inn || "—")}</div>
            <div><strong>Суд:</strong> ${escapeHtml(it.court || "—")}</div>
            ${it.note ? `<div style="color:var(--muted)">${escapeHtml(it.note)}</div>` : ""}
          `;

          const actions = document.createElement("div");
          actions.style.display = "flex";
          actions.style.gap = "8px";
          actions.style.marginTop = "4px";

          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.dataset.action = "edit";
          editBtn.dataset.id = it.id;
          editBtn.style.border = "1px solid var(--divider)";
          editBtn.style.borderRadius = "10px";
          editBtn.style.padding = "6px 10px";
          editBtn.style.background = "transparent";
          editBtn.style.color = "var(--fg)";
          editBtn.style.cursor = "pointer";
          editBtn.textContent = "Редактировать";

          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.dataset.action = "delete";
          delBtn.dataset.id = it.id;
          delBtn.style.border = "1px solid var(--divider)";
          delBtn.style.borderRadius = "10px";
          delBtn.style.padding = "6px 10px";
          delBtn.style.background = "transparent";
          delBtn.style.color = "var(--fg)";
          delBtn.style.cursor = "pointer";
          delBtn.textContent = "Удалить";

          actions.append(editBtn, delBtn);
          card.append(title, meta, actions);
          listEl.appendChild(card);
        });
    }

    // --- Делегирование событий на списке ---
    listEl.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      if (action === "edit") {
        loadIntoForm(id);
      } else if (action === "delete") {
        removeCase(id);
      }
    });

    // --- Помощники ---
    function statusLabel(v) {
      switch (v) {
        case "monitoring": return "Мониторинг";
        case "filed": return "Заявление подано";
        case "observ": return "Наблюдение";
        case "realiz": return "Реализация имущества";
        case "completed": return "Завершено";
        default: return "—";
      }
    }
    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function uid() {
      return "c_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    // --- CRUD ---
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const data = {
        caseNumber: f.caseNumber.value.trim(),
        debtorName: f.debtorName.value.trim(),
        inn: f.inn.value.trim(),
        court: f.court.value.trim(),
        status: f.status.value,
        note: f.note.value.trim(),
      };
      if (!data.caseNumber || !data.debtorName) {
        alert("Поля «Номер дела» и «Должник» обязательны.");
        return;
      }
      if (data.inn && !/^\d{10}(\d{2})?$/.test(data.inn)) {
        alert("ИНН должен содержать 10 или 12 цифр.");
        return;
      }

      const id = editingIdEl.value || uid();
      const now = Date.now();
      const items = loadAll();
      const idx = items.findIndex(x => x.id === id);

      const record = { id, ...data, updatedAt: now, createdAt: items[idx]?.createdAt || now };

      if (idx >= 0) items[idx] = record;
      else items.push(record);

      saveAll(items);
      clearForm();
      render(searchEl.value);
    });

    document.getElementById("reset-form").addEventListener("click", clearForm);

    function clearForm() {
      form.reset();
      editingIdEl.value = "";
    }

    function loadIntoForm(id) {
      const it = loadAll().find(x => x.id === id);
      if (!it) return;
      f.caseNumber.value = it.caseNumber || "";
      f.debtorName.value = it.debtorName || "";
      f.inn.value = it.inn || "";
      f.court.value = it.court || "";
      f.status.value = it.status || "";
      f.note.value = it.note || "";
      editingIdEl.value = it.id;
      form.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function removeCase(id) {
      if (!confirm("Удалить дело?")) return;
      const items = loadAll().filter(x => x.id !== id);
      saveAll(items);
      if (editingIdEl.value === id) clearForm();
      render(searchEl.value);
    }

    // Поиск
    searchEl.addEventListener("input", () => render(searchEl.value));

    // Первичный рендер
    render();
  })();
</script>
