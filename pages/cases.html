<section class="page cases" id="cases-page" aria-labelledby="cases-title">
  <h1 id="cases-title">–î–µ–ª–∞</h1>

  <!-- –ü–∞–Ω–µ–ª—å -->
  <div class="cases-toolbar" role="region" aria-label="–ü–æ–∏—Å–∫ –∏ –¥–µ–π—Å—Ç–≤–∏—è">
    <div class="cases-search">
      <input id="cases-search-input" type="search" placeholder="–ù–æ–º–µ—Ä –¥–µ–ª–∞, –¥–æ–ª–∂–Ω–∏–∫, –ò–ù–ù, –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ"
             aria-label="–ü–æ–∏—Å–∫ –ø–æ –¥–µ–ª–∞–º" oninput="CASES && CASES.setQuery(this.value)" />
      <button class="ghost" aria-label="–û—á–∏—Å—Ç–∏—Ç—å"
              onclick="CASES && CASES.setQuery(''); const i=document.getElementById('cases-search-input'); i.value=''; i.focus();">‚úï</button>
    </div>
    <button class="primary" id="cases-add-btn" aria-expanded="false" onclick="CASES && CASES.toggleForm()">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>

  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <div class="cases-filters" role="tablist" aria-label="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É">
    <button role="tab" class="chip active" data-filter="all" onclick="CASES && CASES.setFilter('all', this)">–í—Å–µ</button>
    <button role="tab" class="chip" data-filter="active" onclick="CASES && CASES.setFilter('active', this)">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
    <button role="tab" class="chip" data-filter="archived" onclick="CASES && CASES.setFilter('archived', this)">–ê—Ä—Ö–∏–≤</button>
  </div>

  <!-- –§–æ—Ä–º–∞ -->
  <div id="cases-form-wrap" class="collapse" aria-hidden="true" style="margin-top:10px;">
    <form id="cases-form" class="cases-form" onsubmit="CASES && CASES.submit(event)">
      <div class="grid">
        <label>
          <span>–ù–æ–º–µ—Ä –¥–µ–ª–∞ *</span>
          <input type="text" id="c-number" required placeholder="–ê40-12345/2025" autocomplete="off" />
        </label>
        <label>
          <span>–î–æ–ª–∂–Ω–∏–∫</span>
          <input type="text" id="c-debtor" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò. / –û–û–û ¬´–†–æ–º–∞—à–∫–∞¬ª" />
        </label>
        <label>
          <span>–ò–ù–ù</span>
          <input type="text" id="c-inn" inputmode="numeric" pattern="[0-9]*" placeholder="–ò–ù–ù (10/12 —Ü–∏—Ñ—Ä)" />
        </label>
        <label>
          <span>–°—É–¥ (–∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –Ω–æ–º–µ—Ä—É)</span>
          <input type="text" id="c-court" placeholder="–û–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É, –º–æ–∂–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" />
        </label>
        <label style="grid-column:1 / -1;">
          <span>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</span>
          <textarea id="c-note" rows="2" placeholder="–õ—é–±—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –¥–µ–ª—É"></textarea>
        </label>
        <label>
          <span>–°—Ç–∞—Ç—É—Å</span>
          <select id="c-status">
            <option value="active" selected>–ê–∫—Ç–∏–≤–Ω–æ–µ</option>
            <option value="archived">–ê—Ä—Ö–∏–≤</option>
          </select>
        </label>
      </div>
      <div class="form-actions">
        <button type="button" class="ghost" onclick="CASES && CASES.toggleForm(false)">–°–≤–µ—Ä–Ω—É—Ç—å</button>
        <button type="submit" class="primary" id="cases-submit-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>

  <!-- –°–ø–∏—Å–æ–∫ -->
  <div id="cases-list" class="cases-list" role="list" aria-label="–°–ø–∏—Å–æ–∫ –¥–µ–ª"></div>

  <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
  <div id="cases-empty" class="cases-empty" hidden>
    <div class="emoji">üìÅ</div>
    <div class="title">–ü–æ–∫–∞ –Ω–µ—Ç –¥–µ–ª</div>
    <div class="hint">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ –¥–µ–ª–æ ‚Äî –Ω–æ–º–µ—Ä, –¥–æ–ª–∂–Ω–∏–∫, –ò–ù–ù‚Ä¶ –°—É–¥ –≤—ã—Å—Ç–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –Ω–æ–º–µ—Ä—É.</div>
    <button class="primary" onclick="CASES && CASES.toggleForm(true)">–î–æ–±–∞–≤–∏—Ç—å</button>
    <div class="list-spacer"></div>
  </div>

  <style>
    /* ‚Äî‚Äî‚Äî —Å—Ç–∏–ª–∏, –∫–∞–∫ –≤ –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–∫–∞—Ö ‚Äî‚Äî‚Äî */
    .cases-toolbar{ display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; }
    .cases-search{ display:grid; grid-template-columns:1fr auto; gap:6px; }
    .cases-search input{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--separator);
      background:var(--tg-theme-secondary-bg-color); color:var(--tg-theme-text-color); outline:none; }
    .cases-search input:focus{ border-color:var(--app-accent); }
    .cases-filters{ display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .chip{ border:1px solid var(--separator); background:transparent; color:var(--tg-theme-text-color);
      padding:6px 10px; border-radius:999px; cursor:pointer; }
    .chip.active{ border-color:var(--app-accent); color:var(--app-accent); font-weight:600; }

    .collapse{ max-height:0; overflow:hidden; opacity:0; transition:max-height 240ms ease, opacity 240ms ease; }
    .collapse.open{ opacity:1; }

    .cases-form{ border:1px solid var(--separator); background:var(--tg-theme-secondary-bg-color);
      border-radius:16px; padding:12px; display:grid; gap:12px; margin-top:8px; }
    .cases-form .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .cases-form label{ display:grid; gap:6px; font-size:12px; color:var(--tg-theme-hint-color); }
    .cases-form input,.cases-form select,.cases-form textarea{
      padding:10px 12px; border-radius:12px; border:1px solid var(--separator);
      background:var(--tg-theme-bg-color); color:var(--tg-theme-text-color); outline:none; resize:vertical;
    }
    .cases-form input:focus,.cases-form select:focus,.cases-form textarea:focus{ border-color:var(--app-accent); }
    .form-actions{ display:flex; gap:8px; justify-content:flex-end; }
    .primary,.ghost{ appearance:none; border:1px solid transparent; padding:10px 12px; border-radius:12px; cursor:pointer;
      background:var(--tg-theme-button-color); color:var(--tg-theme-button-text-color); }
    .ghost{ background:transparent; border-color:var(--separator); color:var(--tg-theme-text-color); }

    .cases-list{ display:grid; gap:8px; margin-top:8px; }
    .case-card{ border:1px solid var(--separator); background:var(--tg-theme-secondary-bg-color);
      border-radius:16px; padding:12px; display:grid; gap:6px; }
    .case-head{ display:flex; justify-content:space-between; align-items:baseline; gap:8px; }
    .case-number{ font-weight:700; }
    .badge{ font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--separator); color:var(--tg-theme-hint-color); }
    .badge.active{ border-color:var(--app-accent); color:var(--app-accent); }

    /* üëâ –ù–æ–≤—ã–π –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –±–ª–æ–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ */
    .case-info{
      display:grid;
      gap:4px;
      color:var(--tg-theme-hint-color);
      font-size:14px;
    }

    @media (max-width:520px){ .cases-form .grid{ grid-template-columns:1fr; } }
  </style>

  <script type="text/plain" id="cases-inline-js">
  (function(){
    /* ===== –•–µ–ª–ø–µ—Ä—ã ===== */
    function setExpanded(btn, wrap, open){ btn?.setAttribute('aria-expanded', String(open)); wrap?.setAttribute('aria-hidden', String(!open)); }
    const LS_KEY='tl_cases_v1';

    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞: –ª–∞—Ç–∏–Ω—Å–∫–∞—è A -> –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∞—è –ê, –≤—Å–µ —Ç–∏—Ä–µ –∫ '-', —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã, –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
    function normalizeCaseNumber(s){
      return String(s||'')
        .toUpperCase()
        .replace(/[A]/g,'–ê')
        .replace(/[‚Äî‚àí‚Äì]/g,'-')
        .replace(/\s+/g,'');
    }

    // –ö–∞—Ä—Ç–∞ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ –∫ —Å—É–¥–∞–º (—Å–æ–∫—Ä–∞—â—ë–Ω–Ω–∞—è, –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å)
    const PREFIX_TO_COURT = {
      '–ê40-':'–ê–° –≥. –ú–æ—Å–∫–≤—ã',
      '–ê41-':'–ê–° –ú–æ—Å–∫–æ–≤—Å–∫–æ–π –æ–±–ª.',
      '–ê56-':'–ê–° –≥. –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞ –∏ –õ–µ–Ω. –æ–±–ª.',
      '–ê50-':'–ê–° –ü—Å–∫–æ–≤—Å–∫–æ–π –æ–±–ª.',
      '–ê43-':'–ê–° –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–æ–π –æ–±–ª.',
      '–ê55-':'–ê–° –°–∞—Ä–∞—Ç–æ–≤—Å–∫–æ–π –æ–±–ª.'
    };
    function courtByNumber(num){
      const n = normalizeCaseNumber(num);
      for(const pref in PREFIX_TO_COURT){ if(n.startsWith(pref)) return PREFIX_TO_COURT[pref]; }
      const m = n.match(/^–ê\d{2}-/); if(m && PREFIX_TO_COURT[m[0]]) return PREFIX_TO_COURT[m[0]];
      return '';
    }

    window.CASES = {
      data: [],
      state: { query:'', filter:'all' },
      editingId: null,

      init(){
        try{ this.data = JSON.parse(localStorage.getItem(LS_KEY)||'[]')||[]; }catch(e){ this.data=[]; }

        // –¢–æ–≥–≥–ª —Ñ–æ—Ä–º—ã
        const wrap=document.getElementById('cases-form-wrap');
        const btn=document.getElementById('cases-add-btn');
        setExpanded(btn, wrap, false);

        // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—É–¥–∞ –ø–æ –Ω–æ–º–µ—Ä—É –¥–µ–ª–∞ + –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–µ—Ñ–∏–∫—Å–∞
        const num = document.getElementById('c-number');
        const court = document.getElementById('c-court');
        const updateCourt = ()=>{
          const auto = courtByNumber(num.value);
          // –µ—Å–ª–∏ –ø—Ä–µ—Ñ–∏–∫—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω ‚Äî –ø–æ–ª–µ —Å—É–¥–∞ –æ—á–∏—â–∞–µ–º
          court.value = auto || '';
        };
        num.addEventListener('input', updateCourt);
        num.addEventListener('change', updateCourt);

        this.render();
      },

      /* ===== UI ===== */
      toggleForm(force){
        const wrap=document.getElementById('cases-form-wrap');
        const btn=document.getElementById('cases-add-btn');
        const isOpen=wrap.classList.contains('open');
        const shouldOpen=(typeof force==='boolean')?force:!isOpen; if(shouldOpen===isOpen) return;
        wrap.style.overflow='hidden';
        if(shouldOpen){
          wrap.classList.add('open'); wrap.style.maxHeight=wrap.scrollHeight+'px'; setExpanded(btn,wrap,true);
          document.getElementById('c-number').focus();
        } else {
          wrap.style.maxHeight=wrap.scrollHeight+'px'; requestAnimationFrame(()=>{ wrap.style.maxHeight='0px'; });
          setExpanded(btn,wrap,false);
          wrap.addEventListener('transitionend',()=>{ wrap.classList.remove('open'); CASES.cancelEdit(); },{once:true});
        }
      },

      setQuery(q){ this.state.query=String(q||''); this.render(); },
      setFilter(f, el){
        this.state.filter=f;
        document.querySelectorAll('.cases-filters .chip').forEach(b=>b.classList.remove('active'));
        el?.classList.add('active');
        this.render();
      },

      /* ===== CRUD ===== */
      submit(ev){
        ev.preventDefault();
        const number=(document.getElementById('c-number')?.value||'').trim();
        const debtor=(document.getElementById('c-debtor')?.value||'').trim();
        const inn   =(document.getElementById('c-inn')?.value||'').trim();
        let   court =(document.getElementById('c-court')?.value||'').trim();
        const note  =(document.getElementById('c-note')?.value||'').trim();
        const status=(document.getElementById('c-status')?.value||'active');

        if(!number){ alert('–£–∫–∞–∂–∏ –Ω–æ–º–µ—Ä –¥–µ–ª–∞'); return; }

        // –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∏–º —Å—É–¥ –æ—Ç –Ω–æ–º–µ—Ä–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        const auto = courtByNumber(number);
        court = auto || court; // –∞–≤—Ç–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ, –Ω–æ –¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—Ä—É—á–Ω—É—é –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø—Ä–µ—Ñ–∏–∫—Å–∞

        const now=Date.now();
        if(this.editingId){
          const i=this.data.findIndex(x=>x.id===this.editingId);
          if(i!==-1) this.data[i]={...this.data[i], number, debtor, inn, court, note, status, updatedAt:now};
        }else{
          this.data.unshift({ id: crypto.randomUUID(), number, debtor, inn, court, note, status, createdAt:now, updatedAt:now });
        }
        localStorage.setItem(LS_KEY, JSON.stringify(this.data));
        this.cancelEdit();
        this.render();
        this.toggleForm(false);
      },

      edit(id){
        const i=this.data.find(x=>x.id===id); if(!i) return; this.editingId=id;
        document.getElementById('c-number').value=i.number||'';
        document.getElementById('c-debtor').value=i.debtor||'';
        document.getElementById('c-inn').value=i.inn||'';
        document.getElementById('c-court').value=i.court||'';
        document.getElementById('c-note').value=i.note||'';              // üëà –≤–µ—Ä–Ω—É–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è
        document.getElementById('c-status').value=i.status||'active';
        document.getElementById('cases-submit-btn').textContent='–û–±–Ω–æ–≤–∏—Ç—å';
        this.toggleForm(true);
      },

      cancelEdit(){
        this.editingId=null;
        document.getElementById('cases-submit-btn').textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        ['c-number','c-debtor','c-inn','c-court','c-note'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
        document.getElementById('c-status').value='active';
      },

      remove(id){
        if(!confirm('–£–¥–∞–ª–∏—Ç—å –¥–µ–ª–æ?')) return;
        this.data=this.data.filter(x=>x.id!==id);
        localStorage.setItem(LS_KEY, JSON.stringify(this.data));
        this.render();
      },

      archive(id){
        const it=this.data.find(x=>x.id===id); if(!it) return; it.status='archived'; it.updatedAt=Date.now();
        localStorage.setItem(LS_KEY, JSON.stringify(this.data)); this.render();
      },
      restore(id){
        const it=this.data.find(x=>x.id===id); if(!it) return; it.status='active'; it.updatedAt=Date.now();
        localStorage.setItem(LS_KEY, JSON.stringify(this.data)); this.render();
      },

      /* ===== –†–µ–Ω–¥–µ—Ä ===== */
      render(){
        const list=document.getElementById('cases-list');
        const empty=document.getElementById('cases-empty');
        const q=(this.state.query||'').toLowerCase().trim();

        let items=[...this.data];

        if(this.state.filter==='active') items=items.filter(i=>i.status!=='archived');
        else if(this.state.filter==='archived') items=items.filter(i=>i.status==='archived');

        if(q){
          items = items.filter(i=>
            (i.number||'').toLowerCase().includes(q) ||
            (i.debtor||'').toLowerCase().includes(q) ||
            (i.inn||'').toLowerCase().includes(q) ||
            (i.court||'').toLowerCase().includes(q) ||
            (i.note||'').toLowerCase().includes(q)
          );
        }

        items.sort((a,b)=> (a.status==='archived')-(b.status==='archived') || (b.updatedAt||0)-(a.updatedAt||0));

        if(!items.length){ list.innerHTML=''; empty.hidden=false; window.adjustBottomSpacer && window.adjustBottomSpacer(); return; }
        empty.hidden=true;

        list.innerHTML = items.map(i=>{
          const badge = i.status==='archived' ? '–ê—Ä—Ö–∏–≤' : '–ê–∫—Ç–∏–≤–Ω–æ–µ';
          const badgeCls = i.status==='archived' ? '' : 'active';

          // üëâ –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫: –î–æ–ª–∂–Ω–∏–∫ ‚Üí –ò–ù–ù ‚Üí –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ ‚Üí –°—É–¥
          const info = `
            <div class="case-info">
              ${i.debtor ? `<div><strong>–î–æ–ª–∂–Ω–∏–∫:</strong> ${i.debtor}</div>` : ''}
              ${i.inn    ? `<div><strong>–ò–ù–ù:</strong> ${i.inn}</div>`         : ''}
              ${i.note   ? `<div><strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> ${i.note}</div>` : ''} <!-- üëà –≤–µ—Ä–Ω—É–ª–∏ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ -->
              ${i.court  ? `<div><strong>–°—É–¥:</strong> ${i.court}</div>`       : ''}
            </div>`;

          // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
          const actions = (i.status==='archived')
            ? `<button class="ghost" onclick="CASES && CASES.restore('${i.id}')">–í–µ—Ä–Ω—É—Ç—å</button>
               <button class="ghost" onclick="CASES && CASES.edit('${i.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
               <button class="ghost" onclick="CASES && CASES.remove('${i.id}')">–£–¥–∞–ª–∏—Ç—å</button>`
            : `<button class="ghost" onclick="CASES && CASES.edit('${i.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
               <button class="ghost" onclick="CASES && CASES.archive('${i.id}')">–í –∞—Ä—Ö–∏–≤</button>
               <button class="ghost" onclick="CASES && CASES.remove('${i.id}')">–£–¥–∞–ª–∏—Ç—å</button>`;

          return `
            <article class="case-card" role="listitem" data-id="${i.id}">
              <div class="case-head">
                <div class="case-number">${i.number}</div>
                <div class="badge ${badgeCls}">${badge}</div>
              </div>
              ${info}
              <div class="case-actions">${actions}</div>
            </article>
          `;
        }).join('');

        window.adjustBottomSpacer && window.adjustBottomSpacer();
      }
    };

    window.CASES.init();
  })();
  </script>
</section>
