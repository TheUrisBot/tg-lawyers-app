<section class="page cases" id="cases-page" aria-labelledby="cases-title">
  <h1 id="cases-title">–î–µ–ª–∞</h1>

  <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
  <div class="cases-toolbar" role="region" aria-label="–ü–æ–∏—Å–∫ –∏ –¥–µ–π—Å—Ç–≤–∏—è">
    <div class="cases-search">
      <input id="cases-search-input" type="search" placeholder="–ù–æ–º–µ—Ä –¥–µ–ª–∞, –ò–ù–ù –∏–ª–∏ –¥–æ–ª–∂–Ω–∏–∫"
             aria-label="–ü–æ–∏—Å–∫ –ø–æ –¥–µ–ª–∞–º" oninput="CASES && CASES.setQuery(this.value)" />
      <button class="ghost" aria-label="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫"
              onclick="CASES && CASES.setQuery(''); const i=document.getElementById('cases-search-input'); i.value=''; i.focus();">‚úï</button>
    </div>
    <button class="primary" id="cases-add-btn" onclick="CASES && CASES.toggleForm()">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>

  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <div class="cases-filters" role="tablist" aria-label="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É">
    <button role="tab" class="chip active" data-filter="all" onclick="CASES && CASES.setFilter('all')">–í—Å–µ</button>
    <button role="tab" class="chip" data-filter="active" onclick="CASES && CASES.setFilter('active')">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
    <button role="tab" class="chip" data-filter="archived" onclick="CASES && CASES.setFilter('archived')">–ê—Ä—Ö–∏–≤</button>
  </div>

  <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
  <form id="cases-form" class="cases-form" onsubmit="CASES && CASES.submit(event)" hidden>
    <div class="grid">
      <label>
        <span>–ù–æ–º–µ—Ä –¥–µ–ª–∞ *</span>
        <input type="text" id="cases-number" required placeholder="–ê40-12345/2025" />
      </label>
      <label>
        <span>–î–æ–ª–∂–Ω–∏–∫ *</span>
        <input type="text" id="cases-debtor" required placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò. / –û–û–û ¬´–†–æ–≥–∞ –∏ –ö–æ–ø—ã—Ç–∞¬ª" />
      </label>
      <label>
        <span>–ò–ù–ù</span>
        <input type="text" id="cases-inn" inputmode="numeric" pattern="\\d{10}|\\d{12}" placeholder="10 –∏–ª–∏ 12 —Ü–∏—Ñ—Ä" />
      </label>
      <label>
        <span>–°—É–¥</span>
        <input type="text" id="cases-court" placeholder="–ê–° –≥. –ú–æ—Å–∫–≤—ã" />
      </label>
      <label>
        <span>–°–ª–µ–¥—É—é—â–µ–µ –∑–∞—Å–µ–¥–∞–Ω–∏–µ</span>
        <input type="date" id="cases-next" />
      </label>
      <label>
        <span>–°—Ç–∞—Ç—É—Å</span>
        <select id="cases-status">
          <option value="active" selected>–ê–∫—Ç–∏–≤–Ω–æ–µ</option>
          <option value="archived">–ê—Ä—Ö–∏–≤</option>
        </select>
      </label>
    </div>
    <div class="form-actions">
      <button type="button" class="ghost" onclick="CASES && CASES.toggleForm(false)">–û—Ç–º–µ–Ω–∞</button>
      <button type="submit" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </form>

  <!-- –°–ø–∏—Å–æ–∫ –¥–µ–ª -->
  <div id="cases-list" class="cases-list" role="list"></div>

  <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
  <div id="cases-empty" class="cases-empty" hidden>
    <div class="emoji" aria-hidden="true">üìÅ</div>
    <div class="title">–ü–æ–∫–∞ –Ω–µ—Ç –¥–µ–ª</div>
    <div class="hint">–î–æ–±–∞–≤—å –ø–µ—Ä–≤–æ–µ –¥–µ–ª–æ –ø–æ –Ω–æ–º–µ—Ä—É –∏–ª–∏ –ò–ù–ù ‚Äî –∏ –Ω–∞—á–Ω—ë–º —Ä–∞–±–æ—Ç–∞—Ç—å.</div>
    <button class="primary" onclick="CASES && CASES.toggleForm(true)">–î–æ–±–∞–≤–∏—Ç—å –¥–µ–ª–æ</button>
  </div>

  <!-- –°—Ç–∏–ª–∏ –¢–û–õ–¨–ö–û –¥–ª—è —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–∏ -->
  <style>
    #cases-page { gap: 14px; }
    .cases-toolbar {
      display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;
    }
    .cases-search { display: grid; grid-template-columns: 1fr auto; gap: 6px; }
    .cases-search input {
      width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--separator);
      background: var(--tg-theme-secondary-bg-color); color: var(--tg-theme-text-color);
      outline: none;
    }
    .cases-search input:focus { border-color: var(--app-accent); }
    .cases-filters { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip {
      border: 1px solid var(--separator); background: transparent; color: var(--tg-theme-text-color);
      padding: 6px 10px; border-radius: 999px; cursor: pointer;
    }
    .chip.active { border-color: var(--app-accent); color: var(--app-accent); font-weight: 600; }
    .cases-form {
      border: 1px solid var(--separator); background: var(--tg-theme-secondary-bg-color);
      border-radius: 16px; padding: 12px; display: grid; gap: 12px;
    }
    .cases-form .grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
    }
    .cases-form label { display: grid; gap: 6px; font-size: 12px; color: var(--tg-theme-hint-color); }
    .cases-form input, .cases-form select {
      padding: 10px 12px; border-radius: 12px; border: 1px solid var(--separator);
      background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color);
      outline: none;
    }
    .cases-form input:focus, .cases-form select:focus { border-color: var(--app-accent); }
    .form-actions { display: flex; gap: 8px; justify-content: flex-end; }
    .primary, .ghost {
      appearance: none; border: 1px solid transparent; padding: 10px 12px; border-radius: 12px; cursor: pointer;
      background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color);
    }
    .ghost { background: transparent; border-color: var(--separator); color: var(--tg-theme-text-color); }
    .cases-list { display: grid; gap: 8px; }
    .case-card {
      border: 1px solid var(--separator); background: var(--tg-theme-secondary-bg-color);
      border-radius: 16px; padding: 12px; display: grid; gap: 6px;
    }
    .case-head { display: flex; justify-content: space-between; align-items: baseline; gap: 8px; }
    .case-number { font-weight: 700; }
    .badge {
      font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid var(--separator);
      color: var(--tg-theme-hint-color);
    }
    .badge.active { color: var(--app-accent); border-color: var(--app-accent); }
    .case-row { display: flex; gap: 10px; flex-wrap: wrap; color: var(--tg-theme-hint-color); font-size: 14px; }
    .case-actions { display: flex; gap: 8px; margin-top: 6px; }
    .cases-empty { border: 1px dashed var(--separator); border-radius: 16px; padding: 20px; text-align: center; }
    .cases-empty .emoji { font-size: 28px; margin-bottom: 6px; }
    .cases-empty .title { font-weight: 700; margin-bottom: 4px; }
    .cases-empty .hint { color: var(--tg-theme-hint-color); margin-bottom: 10px; }

    @media (max-width: 520px) {
      .cases-form .grid { grid-template-columns: 1fr; }
    }
  </style>

  <!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è. –í–ê–ñ–ù–û: —Å–∫—Ä–∏–ø—Ç—ã –≤–æ –≤—Å—Ç–∞–≤–∫–∞—Ö —á–µ—Ä–µ–∑ innerHTML –Ω–µ –∏—Å–ø–æ–ª–Ω—è—é—Ç—Å—è,
       –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º onload —É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —á—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–¥ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ -->
  <img alt="" aria-hidden="true" style="display:none"
       src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
       onload="
         (function () {
           // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–∏
           window.CASES = {
             LS_KEY: 'tl_cases_v1',
             data: [],
             state: { query: '', filter: 'all' },

             init() {
               try {
                 const raw = localStorage.getItem(this.LS_KEY);
                 this.data = raw ? JSON.parse(raw) : [];
               } catch(e) { this.data = []; }

               // –°–∏–¥-–¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
               if (!this.data.length) {
                 this.data = [
                   { id: String(Date.now()-2), number: '–ê40-12345/2025', debtor: '–û–û–û ¬´–°–µ–≤–µ—Ä–¢–æ—Ä–≥¬ª', inn: '7712345678', court: '–ê–° –≥. –ú–æ—Å–∫–≤—ã', next: '2025-09-05', status: 'active', createdAt: Date.now()-20000 },
                   { id: String(Date.now()-1), number: '–ê56-9876/2024', debtor: '–ò–≤–∞–Ω–æ–≤ –ò.–ò.', inn: '781234567890', court: '–ê–° –°–ü–±', next: '2025-08-28', status: 'active', createdAt: Date.now()-10000 },
                   { id: String(Date.now()), number: '–ê40-22222/2023', debtor: '–û–û–û ¬´–†–æ–º–∞—à–∫–∞¬ª', inn: '7722334455', court: '–ê–° –≥. –ú–æ—Å–∫–≤—ã', next: '', status: 'archived', createdAt: Date.now() }
                 ];
                 this.save();
               }
               this.render();
             },

             save() {
               localStorage.setItem(this.LS_KEY, JSON.stringify(this.data));
             },

             setQuery(v) {
               this.state.query = (v || '').toLowerCase();
               this.render();
             },

             setFilter(f) {
               this.state.filter = f;
               // –≤–∏–∑—É–∞–ª—å–Ω–æ –∞–∫—Ç–∏–≤–Ω–∞—è ¬´—á–∏–ø–∞¬ª
               document.querySelectorAll('#cases-page .chip').forEach(ch => {
                 ch.classList.toggle('active', ch.dataset.filter === f);
                 ch.setAttribute('aria-selected', String(ch.dataset.filter === f));
               });
               this.render();
             },

             toggleForm(force) {
               const form = document.getElementById('cases-form');
               const show = (typeof force === 'boolean') ? force : form.hidden;
               form.hidden = !show;
               if (show) document.getElementById('cases-number').focus();
             },

             submit(ev) {
               ev && ev.preventDefault();
               const number = document.getElementById('cases-number').value.trim();
               const debtor = document.getElementById('cases-debtor').value.trim();
               const inn    = document.getElementById('cases-inn').value.trim();
               const court  = document.getElementById('cases-court').value.trim();
               const next   = document.getElementById('cases-next').value;
               const status = document.getElementById('cases-status').value;

               if (!number || !debtor) {
                 alert('–ó–∞–ø–æ–ª–Ω–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –ù–æ–º–µ—Ä –¥–µ–ª–∞ –∏ –î–æ–ª–∂–Ω–∏–∫.');
                 return;
               }
               if (inn && !( /^\\d{10}$/.test(inn) || /^\\d{12}$/.test(inn) )) {
                 alert('–ò–ù–ù –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 10 –∏–ª–∏ 12 —Ü–∏—Ñ—Ä.');
                 return;
               }

               const item = {
                 id: String(Date.now()),
                 number, debtor, inn, court, next,
                 status: status === 'archived' ? 'archived' : 'active',
                 createdAt: Date.now()
               };
               this.data.push(item);
               this.save();
               this.clearForm();
               this.toggleForm(false);
               this.render();
             },

             clearForm() {
               ['cases-number','cases-debtor','cases-inn','cases-court','cases-next'].forEach(id => {
                 const el = document.getElementById(id);
                 if (el) el.value = '';
               });
               document.getElementById('cases-status').value = 'active';
             },

             toggleArchive(id) {
               const item = this.data.find(x => x.id === id);
               if (!item) return;
               item.status = item.status === 'active' ? 'archived' : 'active';
               this.save();
               this.render();
             },

             remove(id) {
               if (!confirm('–£–¥–∞–ª–∏—Ç—å –¥–µ–ª–æ? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) return;
               this.data = this.data.filter(x => x.id !== id);
               this.save();
               this.render();
             },

             formatDate(iso) {
               if (!iso) return '‚Äî';
               try { return new Date(iso).toLocaleDateString('ru-RU'); } catch(e) { return '‚Äî'; }
             },

             render() {
               const list = document.getElementById('cases-list');
               const empty = document.getElementById('cases-empty');

               // —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
               let items = this.data.slice();
               const q = this.state.query;
               if (q) {
                 items = items.filter(i =>
                   i.number.toLowerCase().includes(q) ||
                   (i.debtor || '').toLowerCase().includes(q) ||
                   (i.inn || '').includes(q)
                 );
               }
               if (this.state.filter !== 'all') {
                 items = items.filter(i => i.status === this.state.filter);
               }

               // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –±–ª–∏–∂–∞–π—à–µ–µ –∑–∞—Å–µ–¥–∞–Ω–∏–µ –≤–≤–µ—Ä—Ö; –ø—É—Å—Ç—ã–µ –¥–∞—Ç—ã ‚Äî –≤–Ω–∏–∑; –∑–∞—Ç–µ–º –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é (–Ω–æ–≤—ã–µ –≤–≤–µ—Ä—Ö)
               items.sort((a,b) => {
                 const ad = a.next ? new Date(a.next).getTime() : Infinity;
                 const bd = b.next ? new Date(b.next).getTime() : Infinity;
                 if (ad !== bd) return ad - bd;
                 return b.createdAt - a.createdAt;
               });

               // —Ä–µ–Ω–¥–µ—Ä
               if (!items.length) {
                 list.innerHTML = '';
                 empty.hidden = false;
                 return;
               }
               empty.hidden = true;

               list.innerHTML = items.map(i => `
                 <article class="case-card" role="listitem" data-id="${i.id}">
                   <div class="case-head">
                     <div class="case-number">${i.number}</div>
                     <div class="badge ${i.status === 'active' ? 'active' : ''}">
                       ${i.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω–æ–µ' : '–ê—Ä—Ö–∏–≤'}
                     </div>
                   </div>
                   <div class="case-row">
                     <span><strong>–î–æ–ª–∂–Ω–∏–∫:</strong> ${i.debtor || '‚Äî'}</span>
                     <span><strong>–ò–ù–ù:</strong> ${i.inn || '‚Äî'}</span>
                     <span><strong>–°—É–¥:</strong> ${i.court || '‚Äî'}</span>
                   </div>
                   <div class="case-row">
                     <span><strong>–°–ª–µ–¥—É—é—â–µ–µ –∑–∞—Å–µ–¥–∞–Ω–∏–µ:</strong> ${this.formatDate(i.next)}</span>
                   </div>
                   <div class="case-actions">
                     <button class="ghost" onclick="CASES && CASES.toggleArchive('${i.id}')">
                       ${i.status === 'active' ? '–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–í–µ—Ä–Ω—É—Ç—å –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ'}
                     </button>
                     <button class="ghost" onclick="CASES && CASES.remove('${i.id}')">–£–¥–∞–ª–∏—Ç—å</button>
                   </div>
                 </article>
               `).join('');
             }
           };

           // –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –≤–∫–ª–∞–¥–∫–∏
           window.CASES.init();
         })();
       ">
</section>
