<section class="util" data-util-id="exportimport">
  <!-- Заголовок-аккордеон -->
  <button class="util-accordion" id="exim-toggle" aria-expanded="false" aria-controls="exim-body">
    <span class="title">Экспорт и импорт дел</span>
    <span class="chev" aria-hidden="true">ˬ</span>
  </button>

  <!-- По умолчанию закрыто -->
  <div id="exim-body" class="util-body" aria-hidden="true">
    <div class="util-card">
      <p class="muted">
        Экспортирует все дела из локальной базы (<code>tl_cases_v1</code>). Импорт обновляет записи при совпадении
        <strong>«Номер дела»</strong>, иначе создаёт новые.
      </p>

      <!-- Кнопки экспорта -->
      <div class="btn-row">
        <button class="primary" id="btn-export-xlsx">Экспорт в Excel (.xlsx)</button>
        <button class="ghost"   id="btn-export-csv">Экспорт в CSV</button>
      </div>

      <hr class="sep" />

      <!-- Импорт -->
      <div class="import-wrap">
        <label class="file-label">
          <span>Файл Excel (.xlsx) или CSV</span>
          <input id="exim-file" type="file" accept=".xlsx,.xls,.csv" />
        </label>

        <div id="dropzone" class="dropzone" aria-label="Перетащи файл для импорта">
          Перетащи файл сюда или выбери его выше
        </div>

        <div class="btn-row">
          <button class="primary" id="btn-import">Импортировать</button>
          <button class="ghost" id="btn-cols-hint">Какие столбцы поддерживаются?</button>
        </div>

        <!-- Подсказка по столбцам -->
        <div id="cols-hint" class="hint-collapse" aria-hidden="true">
          <div class="hint-scroll">
            <p class="muted" style="margin-top:0">
              Поддерживаются следующие заголовки (регистр не важен):
            </p>
            <ul class="no-overflow">
              <li><code>Номер дела</code> <strong>(обязателен)</strong></li>
              <li><code>Должник</code></li>
              <li><code>ИНН</code></li>
              <li><code>Суд</code> <span class="muted">— необязателен, определяется автоматически по номеру</span></li>
              <li><code>Примечание</code></li>
              <li><code>Статус</code></li>
            </ul>
            <p class="muted">Лишние столбцы игнорируются. «Номер дела» обязателен.</p>
          </div>
        </div>
      </div>

      <!-- Результат импорта -->
      <div id="import-result" class="result" hidden>
        <div class="result-line">Добавлено: <strong id="res-added">0</strong></div>
        <div class="result-line">Обновлено: <strong id="res-updated">0</strong></div>
        <div class="result-line">Всего в базе: <strong id="res-total">0</strong></div>

        <button class="ghost small" id="btn-toggle-list">Показать список затронутых дел</button>
        <div id="affected-list" class="list-collapse" hidden>
          <ul id="affected-ul"></ul>
        </div>
      </div>
    </div>
  </div>

  <style>
    .util{ display:block; }
    .util .no-overflow { padding-left:18px; margin:6px 0; }
    .util p, .util li, .util code { word-break: break-word; overflow-wrap: anywhere; white-space: normal; }

    .util-card{ border:1px solid var(--separator); background:var(--tg-theme-secondary-bg-color);
      border-radius:16px; padding:12px; display:grid; gap:10px; }
    .muted{ color:var(--tg-theme-hint-color); }
    .btn-row{ display:flex; gap:8px; flex-wrap:wrap; }
    .primary,.ghost{ appearance:none; border:1px solid transparent; padding:10px 12px; border-radius:12px; cursor:pointer;
      background:var(--tg-theme-button-color); color:var(--tg-theme-button-text-color); }
    .ghost{ background:transparent; border-color:var(--separator); color:var(--tg-theme-text-color); }
    .ghost.small{ padding:6px 10px; border-radius:10px; }

    .sep{ border:none; border-top:1px solid var(--separator); margin:4px 0; }

    .file-label{ display:grid; gap:6px; font-size:12px; color:var(--tg-theme-hint-color); }
    .file-label input{ padding:10px 12px; border-radius:12px; border:1px solid var(--separator);
      background:var(--tg-theme-bg-color); color:var(--tg-theme-text-color); width:100%; }

    .dropzone{ border:1px dashed var(--separator); border-radius:12px; padding:16px; text-align:center;
      color:var(--tg-theme-hint-color); min-height:56px; display:flex; align-items:center; justify-content:center; }
    .dropzone.drag{ border-color:var(--app-accent); color:var(--app-accent); }

    /* Аккордеон */
    .util-accordion{ width:100%; display:flex; align-items:center; justify-content:space-between; gap:8px;
      border:1px solid var(--separator); background:var(--tg-theme-secondary-bg-color); color:var(--tg-theme-text-color);
      padding:12px; border-radius:14px; cursor:pointer; }
    .util-accordion .title{ font-weight:600; }
    .util-accordion .chev{ font-size:1em; transition:transform .2s ease; }

    /* Тело аккордеона закрыто по умолчанию */
    .util-body{ overflow:hidden; transition:max-height .24s ease, opacity .24s ease; max-height:0; opacity:0; margin-top:6px; }
    .util-body.open{ opacity:1; }

    /* hint/list collapses */
    .hint-collapse{ border:1px dashed var(--separator); border-radius:12px; padding:10px; margin-top:6px; display:none; }
    .hint-collapse.open{ display:block; }
    .hint-scroll{ max-height:220px; overflow:auto; }
    .list-collapse{ display:none; }
    .list-collapse.open{ display:block; }
    #affected-ul{ margin:6px 0 0 0; padding:0 0 0 18px; }
  </style>

  <!-- ВАЖНО: скрипт в формате, как в других вкладках (text/plain) -->
  <script type="text/plain" id="exportimport-inline-js">
  (function(){
    const LS_CASES = 'tl_cases_v1';

    // ===== Аккордеон (по умолчанию закрыт)
    (function(){
      const btn  = document.getElementById('exim-toggle');
      const body = document.getElementById('exim-body');
      if (!btn || !body) return;

      function open(){
        btn.setAttribute('aria-expanded','true');
        body.setAttribute('aria-hidden','false');
        body.classList.add('open');

        body.style.overflow = 'hidden';
        body.style.maxHeight = body.scrollHeight + 'px';
        const onEnd = ()=>{ body.style.maxHeight = 'none'; body.style.overflow = 'visible'; body.removeEventListener('transitionend', onEnd); };
        body.addEventListener('transitionend', onEnd);
        const chev = btn.querySelector('.chev'); if (chev) chev.style.transform='rotate(180deg)';
      }
      function close(){
        btn.setAttribute('aria-expanded','false');
        body.setAttribute('aria-hidden','true');
        body.classList.remove('open');
        const chev = btn.querySelector('.chev'); if (chev) chev.style.transform='';
        body.style.maxHeight = body.scrollHeight + 'px';
        requestAnimationFrame(()=>{ body.style.maxHeight = '0px'; body.style.overflow='hidden'; });
      }
      btn.addEventListener('click', ()=> (btn.getAttribute('aria-expanded')==='true'? close():open()));
      // подстраиваем max-height во время ресайза
      window.addEventListener('resize', ()=>{
        if (btn.getAttribute('aria-expanded') === 'true' && body.style.maxHeight !== 'none'){
          body.style.maxHeight = body.scrollHeight + 'px';
        }
      });
    })();

    // ===== Helpers
    function readCases(){
      try { const raw=localStorage.getItem(LS_CASES); const arr=raw?JSON.parse(raw):[]; return Array.isArray(arr)?arr:[]; }
      catch(_){ return []; }
    }
    function saveCases(arr){ localStorage.setItem(LS_CASES, JSON.stringify(arr||[])); }
    function normalizeStatus(s){
      const v=String(s||'').toLowerCase();
      return (v==='archived' || v==='архив') ? 'archived' : 'active';
    }
    function ensureXLSX(){
      return new Promise((resolve, reject)=>{
        if (window.XLSX) return resolve(window.XLSX);
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
        s.onload = ()=> resolve(window.XLSX);
        s.onerror = ()=> reject(new Error("Не удалось загрузить библиотеку XLSX"));
        document.head.appendChild(s);
      });
    }

    // === Автоопределение суда по номеру дела (укороченная карта; при желании расширим)
    const PREFIX_TO_COURT = {
      'А01-': 'АС Респ. Адыгея',
      'А02-': 'АС Респ. Алтай',
      'А03-': 'АС Алтайского края',
      'А04-': 'АС Амурской обл.',
      'А05-': 'АС Архангельской обл.',
      'А06-': 'АС Астраханской обл.',
      'А07-': 'АС Респ. Башкортостан',
      'А08-': 'АС Белгородской обл.',
      'А09-': 'АС Брянской обл.',
      'А10-': 'АС Респ. Бурятия',
      'А11-': 'АС Владимирской обл.',
      'А12-': 'АС Волгоградской обл.',
      'А13-': 'АС Вологодской обл.',
      'А14-': 'АС Воронежской обл.',
      'А15-': 'АС Еврейской АО',
      'А16-': 'АС Забайкальского края',
      'А17-': 'АС Ивановской обл.',
      'А18-': 'АС Иркутской обл.',
      'А19-': 'АС Кабардино-Балкарской Респ.',
      'А20-': 'АС Калининградской обл.',
      'А21-': 'АС Калужской обл.',
      'А22-': 'АС Камчатского края',
      'А23-': 'АС Карачаево-Черкесской Респ.',
      'А24-': 'АС Респ. Карелия',
      'А25-': 'АС Кемеровской обл.',
      'А26-': 'АС Кировской обл.',
      'А27-': 'АС Респ. Коми',
      'А28-': 'АС Костромской обл.',
      'А29-': 'АС Архангельской обл.',
      'А31-': 'АС Белгородской обл.',
      'А32-': 'АС Краснодарского края',
      'А33-': 'АС Красноярского края',
      'А34-': 'АС Курганской обл.',
      'А35-': 'АС Курской обл.',
      'А36-': 'АС Липецкой обл.',
      'А37-': 'АС Магаданской обл.',
      'А38-': 'АС Респ. Марий Эл',
      'А39-': 'АС Респ. Мордовия',
      'А40-': 'АС г. Москвы',
      'А41-': 'АС Моск. обл.',
      'А42-': 'АС Мурманской обл.',
      'А43-': 'АС Нижегородской обл.',
      'А44-': 'АС Новгородской обл.',
      'А45-': 'АС Новосибирской обл.',
      'А46-': 'АС Омской обл.',
      'А47-': 'АС Оренбургской обл.',
      'А48-': 'АС Орловской обл.',
      'А49-': 'АС Пензенской обл.',
      'А50-': 'АС Пермского края',
      'А51-': 'АС Приморского края',
      'А52-': 'АС Псковской обл.',
      'А53-': 'АС Ростовской обл.',
      'А54-': 'АС Рязанской обл.',
      'А55-': 'АС Самарской обл.',
      'А56-': 'АС г. Санкт-Петербурга и Лен. обл.',
      'А57-': 'АС Саратовской обл.',
      'А58-': 'АС Респ. Саха (Якутия)',
      'А59-': 'АС Сахалинской обл.',
      'А60-': 'АС Свердловской обл.',
      'А61-': 'АС Смоленской обл.',
      'А62-': 'АС Ставропольского края',
      'А63-': 'АС Тамбовской обл.',
      'А64-': 'АС Тверской обл.',
      'А65-': 'АС Томской обл.',
      'А66-': 'АС Тульской обл.',
      'А67-': 'АС Тюменской обл.',
      'А68-': 'АС Ульяновской обл.',
      'А69-': 'АС Хабаровского края',
      'А70-': 'АС Ханты-Мансийского АО',
      'А71-': 'АС Челябинской обл.',
      'А72-': 'АС Чеченской Респ.',
      'А73-': 'АС Чувашской Респ.',
      'А74-': 'АС Чукотского АО',
      'А75-': 'АС Ямало-Ненецкого АО',
      'А76-': 'АС Ярославской обл.'
    };
    function normalizeCaseNumber(s){
      return String(s||'')
        .toUpperCase()
        .replace(/[A]/g,'А')        // латинская A -> кириллическая А
        .replace(/[—−–]/g,'-')      // все варианты тире -> дефис
        .replace(/\s+/g,'');        // убрать пробелы
    }
    function guessCourtByNumber(num){
      const n = normalizeCaseNumber(num);
      for (const pref in PREFIX_TO_COURT){
        if (Object.prototype.hasOwnProperty.call(PREFIX_TO_COURT, pref) && n.startsWith(pref)){
          return PREFIX_TO_COURT[pref];
        }
      }
      const m = n.match(/^А\d{2}-/);
      if (m && PREFIX_TO_COURT[m[0]]) return PREFIX_TO_COURT[m[0]];
      return '';
    }

    // ===== Экспорт
    async function exportXLSX(){
      const data = readCases();
      const rows = data.map(i=>({
        'Номер дела': i.number || '',
        'Должник':    i.debtor || '',
        'ИНН':        i.inn || '',
        'Суд':        i.court || '',
        'Примечание': i.note || '',
        'Статус':     i.status || 'active',
      }));
      const XLSX = await ensureXLSX();
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Дела');
      const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
      const blob = new Blob([wbout], {type:'application/octet-stream'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'cases_export.xlsx'; document.body.appendChild(a); a.click(); a.remove();
    }
    function exportCSV(){
      const data = readCases();
      const cols = ['Номер дела','Должник','ИНН','Суд','Примечание','Статус'];
      const esc = (v)=>('"'+String(v??'').replace(/"/g,'""')+'"');
      const lines = [cols.join(';')].concat(data.map(i=>[
        esc(i.number||''), esc(i.debtor||''), esc(i.inn||''), esc(i.court||''), esc(i.note||''), esc(i.status||'active')
      ].join(';')));
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'cases_export.csv'; document.body.appendChild(a); a.click(); a.remove();
    }

    // ===== Импорт
    function parseCSV(text){
      const rows = text.replace(/\r/g,'').split('\n').filter(Boolean)
        .map(r=>r.split(';').map(s=>s.replace(/^"|"$/g,'').replace(/""/g,'"')));
      const [head, ...body] = rows;
      return { head, body };
    }
    function headerIndex(head, names){
      const lower = head.map(h=> String(h||'').toLowerCase().trim());
      for (const n of names){ const i = lower.indexOf(n.toLowerCase()); if (i !== -1) return i; }
      return -1;
    }

    async function importFile(file){
      if (!file) { alert('Выбери файл .xlsx или .csv'); return; }

      const affected = [];
      let added=0, updated=0;
      let rows = [];

      if (/\.xlsx?$/i.test(file.name)) {
        const XLSX = await ensureXLSX();
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, {type:'array'});
        const first = wb.SheetNames[0];
        const ws = wb.Sheets[first];
        const json = XLSX.utils.sheet_to_json(ws, {defval:''});
        rows = json.map(r=>{
          const m = {};
          Object.keys(r).forEach(k => { m[String(k).toLowerCase().trim()] = r[k]; });
          return {
            number: m['номер дела'] || '',
            debtor: m['должник'] || '',
            inn:    m['инн'] || '',
            court:  '', // из файла не берём
            note:   m['примечание'] || '',
            status: normalizeStatus(m['статус']),
          };
        });
      } else if (/\.csv$/i.test(file.name)) {
        const text = await file.text();
        const {head, body} = parseCSV(text);
        const idxNumber = headerIndex(head, ['номер дела']);
        const idxDebtor = headerIndex(head, ['должник']);
        const idxINN    = headerIndex(head, ['инн']);
        const idxNote   = headerIndex(head, ['примечание']);
        const idxStatus = headerIndex(head, ['статус']);

        rows = body.map(r=>({
          number: idxNumber>=0 ? r[idxNumber] : '',
          debtor: idxDebtor>=0 ? r[idxDebtor] : '',
          inn:    idxINN>=0 ? r[idxINN] : '',
          court:  '', // из файла не берём
          note:   idxNote>=0 ? r[idxNote] : '',
          status: normalizeStatus(idxStatus>=0 ? r[idxStatus] : ''),
        })).filter(x=>x.number);
      } else {
        alert('Поддерживаются файлы .xlsx и .csv'); return;
      }

      // === Автоматически определить суд по номеру дела ===
      for (const r of rows){ r.court = guessCourtByNumber(r.number); }
      if (!rows.length){ alert('Файл пуст или не распознан'); return; }

      const data = readCases();
      const byNumber = new Map(data.map(i=>[String(i.number).trim(), i]));
      rows.forEach(r=>{
        const key = String(r.number||'').trim();
        if (!key) return;
        const existing = byNumber.get(key);
        if (existing){
          existing.debtor = r.debtor ?? existing.debtor;
          existing.inn    = r.inn ?? existing.inn;
          existing.court  = r.court || existing.court;
          existing.note   = r.note ?? existing.note;
          existing.status = r.status || existing.status || 'active';
          existing.updatedAt = Date.now();
          updated++;
          affected.push({type:'update', number:key});
        } else {
          const item = {
            id:String(Date.now())+Math.random().toString(16).slice(2),
            number:key, debtor:r.debtor||'', inn:r.inn||'', court:r.court||'',
            note:r.note||'', status:r.status||'active',
            createdAt:Date.now(), updatedAt:Date.now()
          };
          data.push(item);
          byNumber.set(key, item);
          added++;
          affected.push({type:'add', number:key});
        }
      });

      saveCases(data);
      showResult({added, updated, total:data.length, affected});
    }

    // ===== UI wiring
    function slideToggle(el){
      if (!el) return;
      if (el.classList.contains('open')) { el.classList.remove('open'); el.setAttribute('aria-hidden','true'); }
      else { el.classList.add('open'); el.setAttribute('aria-hidden','false'); }
    }
    function showResult({added, updated, total, affected}){
      const res = document.getElementById('import-result');
      if (!res) return;
      res.hidden = false;
      res.querySelector('#res-added').textContent   = String(added);
      res.querySelector('#res-updated').textContent = String(updated);
      res.querySelector('#res-total').textContent   = String(total);

      const btn = document.getElementById('btn-toggle-list');
      const listWrap = document.getElementById('affected-list');
      const ul = document.getElementById('affected-ul');
      if (ul){
        ul.innerHTML = affected.map(a=>`<li>${a.type==='add'?'Добавлено':'Обновлено'}: <code>${a.number}</code></li>`).join('');
      }
      if (btn && listWrap){
        btn.onclick = ()=>{
          listWrap.hidden = !listWrap.hidden;
          btn.textContent = listWrap.hidden ? 'Показать список затронутых дел' : 'Скрыть список';
        };
      }
    }

    function initUI(){
      const btnX = document.getElementById('btn-export-xlsx');
      const btnC = document.getElementById('btn-export-csv');
      const btnI = document.getElementById('btn-import');
      const inp  = document.getElementById('exim-file');
      const dz   = document.getElementById('dropzone');
      const btnH = document.getElementById('btn-cols-hint');
      const hint = document.getElementById('cols-hint');

      btnX && (btnX.onclick = exportXLSX);
      btnC && (btnC.onclick = exportCSV);
      btnI && (btnI.onclick = ()=> importFile(inp?.files?.[0]));

      // подсказка столбцов
      if (btnH && hint){
        btnH.onclick = ()=> slideToggle(hint);
      }

      // drag&drop
      if (dz){
        const on = (e)=>{ e.preventDefault(); e.stopPropagation(); };
        ['dragenter','dragover','dragleave','drop'].forEach(ev=> dz.addEventListener(ev, on));
        dz.addEventListener('dragenter', ()=> dz.classList.add('drag'));
        dz.addEventListener('dragover',  ()=> dz.classList.add('drag'));
        dz.addEventListener('dragleave', ()=> dz.classList.remove('drag'));
        dz.addEventListener('drop', async (e)=>{
          dz.classList.remove('drag');
          const file = e.dataTransfer?.files?.[0];
          if (file){
            (document.getElementById('exim-file')||{}).files = e.dataTransfer.files;
            await importFile(file);
          }
        });
      }
    }

    initUI();
  })();
  </script>
</section>
